# События, создающие уведомления

Документ описывает, какие события в системе создают уведомления для пользователей.

## Типы событий, создающих уведомления

### 1. События загрузки файлов (Upload Events)

**Где создаются:** `backend/app/services/upload_event_service.py`

**Когда создаются:**
- При успешной загрузке файла транзакций
- При частичной загрузке (некоторые транзакции пропущены)
- При ошибке загрузки файла

**Категория уведомлений:** `upload_events` или `errors`

**Типы уведомлений:**
- `success` - успешная загрузка
- `warning` - частичная загрузка
- `error` - ошибка загрузки

**Примеры:**
- "Загрузка завершена: transactions.xlsx"
- "Частичная загрузка: transactions.xlsx"
- "Ошибка загрузки: transactions.xlsx"

**Условия создания:**
- Должен быть указан `user_id` при вызове `log_event`
- Уведомление создается с `force=True` (обязательное, игнорирует настройки пользователя)

### 2. События входа в систему (Login Events)

**Где создаются:** `backend/app/routers/auth.py`

**Когда создаются:**
- При успешном входе пользователя через `/api/v1/auth/login`
- При успешном входе через `/api/v1/auth/login-json`
- При успешном входе через `/api/v1/auth/login-secure`

**Категория уведомлений:** `system`

**Тип уведомления:** `success`

**Пример:**
- "Успешный вход в систему"
- "Вы успешно вошли в систему.\nС [IP адрес]"

**Условия создания:**
- Уведомление создается с `force=True` (обязательное, игнорирует настройки пользователя)
- Создается только для успешных входов

## События, которые НЕ создают уведомления

### 1. Действия пользователей (User Actions)

**Где логируются:** `backend/app/services/logging_service.py`

**Что логируется:**
- Создание, обновление, удаление сущностей
- Просмотр данных
- Экспорт данных
- И другие действия пользователей

**Почему не создают уведомления:**
- Это системные логи для аудита
- Не требуют немедленного внимания пользователя
- Создаются слишком часто

### 2. Системные события (System Events)

**Где логируются:** `backend/app/services/logging_service.py`

**Что логируется:**
- Ошибки базы данных
- Ошибки сервисов
- Предупреждения системы

**Почему не создают уведомления:**
- Это системные логи для администраторов
- Обычно не требуют внимания обычных пользователей

## Настройки уведомлений

### Категории уведомлений

1. **`upload_events`** - события загрузки файлов
2. **`errors`** - ошибки загрузки
3. **`system`** - системные уведомления (вход в систему)

### Каналы доставки

По умолчанию все уведомления создаются только через канал `in_app` (внутри системы).

## Как добавить новое событие, создающее уведомление

1. Импортируйте `NotificationService`:
```python
from app.services.notification_service import NotificationService
```

2. Создайте экземпляр сервиса:
```python
notification_service = NotificationService(db)
```

3. Вызовите `send_notification`:
```python
notification_service.send_notification(
    user_id=user.id,
    title="Заголовок уведомления",
    message="Текст уведомления",
    category="system",  # или "upload_events", "errors"
    notification_type="success",  # или "warning", "error", "info"
    channels=["in_app"],
    force=True  # если уведомление обязательное
)
```

## Примечания

- Уведомления создаются только если указан `user_id`
- При `force=True` уведомление создается независимо от настроек пользователя
- Все уведомления сохраняются в таблице `notifications` в базе данных
- Toast-уведомления на фронтенде - это отдельный механизм, не связанный с уведомлениями в базе данных

