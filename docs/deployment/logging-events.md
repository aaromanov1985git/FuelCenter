# События, попадающие в журналы логирования

## Системные логи (SystemLog)

Системные логи записываются в таблицу `system_logs` и содержат информацию о работе системы.

### 1. События запуска приложения (`event_type: "system"`, `event_category: "startup"`)

- **Запуск приложения**
  - Уровень: `INFO`
  - Модуль: `main`
  - Функция: `startup_event`
  - Сообщение: "Приложение запущено"
  - Дополнительные данные: версия API

- **Завершение инициализации**
  - Уровень: `INFO`
  - Модуль: `main`
  - Функция: `startup_event`
  - Сообщение: "Инициализация приложения завершена"
  - Дополнительные данные: статус успешного завершения

- **Ошибка инициализации**
  - Уровень: `ERROR`
  - Модуль: `main`
  - Функция: `startup_event`
  - Сообщение: "Ошибка при инициализации приложения: {описание ошибки}"
  - Дополнительные данные: тип ошибки, сообщение об ошибке
  - Исключение: полная информация об ошибке

### 2. События планировщика (`event_type: "scheduler"`, `event_category: "startup"`)

- **Инициализация планировщика**
  - Уровень: `INFO`
  - Модуль: `main`
  - Функция: `startup_event`
  - Сообщение: "Планировщик автоматической загрузки инициализирован"
  - Дополнительные данные: количество запланированных задач, статус планировщика

- **Детали запланированных задач**
  - Уровень: `INFO` или `WARNING`
  - Модуль: `main`
  - Функция: `startup_event`
  - Сообщение: "Запланированные задачи автоматической загрузки" или "Не найдено запланированных задач"
  - Дополнительные данные: список задач с деталями

- **Ошибка инициализации планировщика**
  - Уровень: `ERROR`
  - Модуль: `main`
  - Функция: `startup_event`
  - Сообщение: "Критическая ошибка при инициализации планировщика: {описание}"
  - Дополнительные данные: тип ошибки, сообщение об ошибке
  - Исключение: полная информация об ошибке

### 3. HTTP запросы (`event_type: "request"`, `event_category: "http"`)

**Логируются ВСЕ HTTP запросы** (кроме служебных endpoints):
- `/health`
- `/api/v1/config`
- `/docs`
- `/openapi.json`
- `/redoc`

- **Успешные запросы (status < 500)**
  - Уровень: `INFO`
  - Модуль: `middleware`
  - Функция: `dispatch`
  - Сообщение: `HTTP {METHOD} {path} - {status_code}`
  - Дополнительные данные:
    - `method`: HTTP метод (GET, POST, PUT, DELETE и т.д.)
    - `path`: путь запроса
    - `status_code`: код ответа
    - `client_ip`: IP адрес клиента
    - `process_time_ms`: время обработки в миллисекундах

- **Ошибки сервера (status >= 500)**
  - Уровень: `ERROR`
  - Модуль: `middleware`
  - Функция: `dispatch`
  - Сообщение: `HTTP {METHOD} {path} - {status_code}`
  - Дополнительные данные: те же, что и для успешных запросов

- **Исключения при обработке запросов**
  - Уровень: `ERROR`
  - Модуль: `middleware`
  - Функция: `dispatch`
  - Сообщение: "Ошибка при обработке запроса: {METHOD} {path}"
  - Дополнительные данные:
    - `method`: HTTP метод
    - `path`: путь запроса
    - `client_ip`: IP адрес клиента
    - `process_time_ms`: время обработки
  - Исключение: полная информация об ошибке

## Действия пользователей (UserActionLog)

Действия пользователей записываются в таблицу `user_action_logs` и содержат информацию о действиях, выполняемых пользователями системы.

### 1. Аутентификация (`action_category: "auth"`)

- **Успешный вход в систему**
  - Тип действия: `login`
  - Категория: `auth`
  - Описание: "Успешный вход пользователя: {username}"
  - Статус: `success`
  - Дополнительные данные:
    - `user_id`: ID пользователя
    - `username`: имя пользователя
    - `ip_address`: IP адрес
    - `user_agent`: User-Agent браузера
    - `request_method`: HTTP метод (обычно POST)
    - `request_path`: путь запроса (обычно `/api/v1/auth/login` или `/api/v1/auth/login-json`)

- **Неудачная попытка входа**
  - Тип действия: `login`
  - Категория: `auth`
  - Описание: "Неудачная попытка входа: {username}"
  - Статус: `failed`
  - Сообщение об ошибке: "Неверное имя пользователя или пароль"
  - Дополнительные данные: те же, что и для успешного входа (но `user_id` = `None`)

- **Создание пользователя**
  - Тип действия: `create`
  - Категория: `auth`
  - Описание: "Создан новый пользователь: {username}"
  - Тип сущности: `User`
  - ID сущности: ID созданного пользователя
  - Статус: `success`
  - Дополнительные данные:
    - `user_id`: ID администратора, создавшего пользователя
    - `username`: имя администратора

### 2. CRUD операции с организациями (`action_category: "organization"`)

- **Создание организации**
  - Тип действия: `create`
  - Категория: `organization`
  - Описание: "Создана организация: {name}"
  - Тип сущности: `Organization`
  - ID сущности: ID созданной организации
  - Статус: `success`

- **Обновление организации**
  - Тип действия: `update`
  - Категория: `organization`
  - Описание: "Обновлена организация: {name}"
  - Тип сущности: `Organization`
  - ID сущности: ID организации
  - Статус: `success`

- **Удаление организации**
  - Тип действия: `delete`
  - Категория: `organization`
  - Описание: "Удалена организация с ID: {id}"
  - Тип сущности: `Organization`
  - ID сущности: ID удаленной организации
  - Статус: `success`

- **Назначение организаций пользователю**
  - Тип действия: `assign`
  - Категория: `organization`
  - Описание: "Назначены организации пользователю ID: {user_id}"
  - Тип сущности: `User`
  - ID сущности: ID пользователя
  - Статус: `success`
  - Дополнительные данные: список ID назначенных организаций

### 3. CRUD операции с пользователями (`action_category: "user"`)

- **Обновление пользователя**
  - Тип действия: `update`
  - Категория: `user`
  - Описание: "Обновлен пользователь: {username}"
  - Тип сущности: `User`
  - ID сущности: ID пользователя
  - Статус: `success`
  - Дополнительные данные: список измененных полей

- **Удаление пользователя**
  - Тип действия: `delete`
  - Категория: `user`
  - Описание: "Удален пользователь: {username}"
  - Тип сущности: `User`
  - ID сущности: ID удаленного пользователя
  - Статус: `success`

**Примечание:** Создание пользователя уже логируется в разделе аутентификации.

### 4. CRUD операции с провайдерами (`action_category: "provider"`)

- **Создание провайдера**
  - Тип действия: `create`
  - Категория: `provider`
  - Описание: "Создан провайдер: {name}"
  - Тип сущности: `Provider`
  - ID сущности: ID созданного провайдера
  - Статус: `success`

- **Обновление провайдера**
  - Тип действия: `update`
  - Категория: `provider`
  - Описание: "Обновлен провайдер: {name}"
  - Тип сущности: `Provider`
  - ID сущности: ID провайдера
  - Статус: `success`

- **Удаление провайдера**
  - Тип действия: `delete`
  - Категория: `provider`
  - Описание: "Удален провайдер: {name}"
  - Тип сущности: `Provider`
  - ID сущности: ID удаленного провайдера
  - Статус: `success`

### 5. CRUD операции с шаблонами (`action_category: "template"`)

- **Создание шаблона**
  - Тип действия: `create`
  - Категория: `template`
  - Описание: "Создан шаблон: {name}"
  - Тип сущности: `ProviderTemplate`
  - ID сущности: ID созданного шаблона
  - Статус: `success`
  - Дополнительные данные: ID провайдера

- **Обновление шаблона**
  - Тип действия: `update`
  - Категория: `template`
  - Описание: "Обновлен шаблон: {name}"
  - Тип сущности: `ProviderTemplate`
  - ID сущности: ID шаблона
  - Статус: `success`

- **Удаление шаблона**
  - Тип действия: `delete`
  - Категория: `template`
  - Описание: "Удален шаблон: {name}"
  - Тип сущности: `ProviderTemplate`
  - ID сущности: ID удаленного шаблона
  - Статус: `success`

### 6. Операции с транзакциями (`action_category: "transaction"`)

- **Загрузка файла транзакций**
  - Тип действия: `upload`
  - Категория: `transaction`
  - Описание: "Загружен файл транзакций: {filename}"
  - Тип сущности: `Transaction`
  - Статус: `success`
  - Дополнительные данные:
    - `file_name`: имя файла
    - `provider_id`: ID провайдера
    - `template_id`: ID шаблона
    - `transactions_total`: общее количество транзакций
    - `transactions_created`: количество созданных транзакций
    - `transactions_skipped`: количество пропущенных транзакций

- **Удаление транзакции**
  - Тип действия: `delete`
  - Категория: `transaction`
  - Описание: "Удалена транзакция ID: {id}"
  - Тип сущности: `Transaction`
  - ID сущности: ID удаленной транзакции
  - Статус: `success`

- **Очистка всех транзакций**
  - Тип действия: `clear`
  - Категория: `transaction`
  - Описание: "Очищены все транзакции ({count} записей)"
  - Тип сущности: `Transaction`
  - Статус: `success`
  - Дополнительные данные: количество удаленных записей

- **Очистка транзакций по провайдеру**
  - Тип действия: `clear`
  - Категория: `transaction`
  - Описание: "Очищены транзакции провайдера '{name}' {period_info} ({count} записей)"
  - Тип сущности: `Provider`
  - ID сущности: ID провайдера
  - Статус: `success`
  - Дополнительные данные:
    - `provider_id`: ID провайдера
    - `provider_name`: имя провайдера
    - `deleted_count`: количество удаленных записей
    - `date_from`: начальная дата периода (если указана)
    - `date_to`: конечная дата периода (если указана)

### 7. Операции с транспортными средствами (`action_category: "vehicle"`)

- **Обновление транспортного средства**
  - Тип действия: `update`
  - Категория: `vehicle`
  - Описание: "Обновлено транспортное средство: {name}"
  - Тип сущности: `Vehicle`
  - ID сущности: ID ТС
  - Статус: `success`

- **Слияние транспортных средств**
  - Тип действия: `merge`
  - Категория: `vehicle`
  - Описание: "Объединены ТС: '{source_name}' с '{target_name}'"
  - Тип сущности: `Vehicle`
  - ID сущности: ID целевого ТС
  - Статус: `success`
  - Дополнительные данные:
    - `source_vehicle_id`: ID исходного ТС
    - `target_vehicle_id`: ID целевого ТС

### 8. Операции с АЗС (`action_category: "gas_station"`)

- **Обновление АЗС**
  - Тип действия: `update`
  - Категория: `gas_station`
  - Описание: "Обновлена АЗС: {name}"
  - Тип сущности: `GasStation`
  - ID сущности: ID АЗС
  - Статус: `success`

### 9. Операции с топливными картами (`action_category: "fuel_card"`)

- **Обновление топливной карты**
  - Тип действия: `update`
  - Категория: `fuel_card`
  - Описание: "Обновлена топливная карта: {card_number}"
  - Тип сущности: `FuelCard`
  - ID сущности: ID карты
  - Статус: `success`

- **Назначение карты на ТС**
  - Тип действия: `assign`
  - Категория: `fuel_card`
  - Описание: "Назначена карта '{card_number}' на ТС '{vehicle_name}'"
  - Тип сущности: `FuelCard`
  - ID сущности: ID карты
  - Статус: `success`
  - Дополнительные данные:
    - `card_id`: ID карты
    - `vehicle_id`: ID ТС
    - `start_date`: дата начала назначения
    - `end_date`: дата окончания назначения

- **Слияние топливных карт**
  - Тип действия: `merge`
  - Категория: `fuel_card`
  - Описание: "Объединены карты: '{source_card}' с '{target_card}'"
  - Тип сущности: `FuelCard`
  - ID сущности: ID целевой карты
  - Статус: `success`
  - Дополнительные данные:
    - `source_card_id`: ID исходной карты
    - `target_card_id`: ID целевой карты
    - `transactions_updated`: количество обновленных транзакций

### 10. Настройки системы (`action_category: "settings"`)

- **Создание блокировки периода загрузки**
  - Тип действия: `create`
  - Категория: `settings`
  - Описание: "Создана блокировка периода загрузки до {date}"
  - Тип сущности: `UploadPeriodLock`
  - ID сущности: ID блокировки
  - Статус: `success`
  - Дополнительные данные: дата блокировки

- **Удаление блокировки периода загрузки**
  - Тип действия: `delete`
  - Категория: `settings`
  - Описание: "Удалена блокировка периода загрузки (была до {date})"
  - Тип сущности: `UploadPeriodLock`
  - Статус: `success`
  - Дополнительные данные: дата удаленной блокировки

### 11. Выход из системы (`action_category: "auth"`)

- **Выход пользователя**
  - Тип действия: `logout`
  - Категория: `auth`
  - Описание: "Выход пользователя: {username}"
  - Статус: `success`
  - Дополнительные данные:
    - `user_id`: ID пользователя
    - `username`: имя пользователя
    - `ip_address`: IP адрес
    - `user_agent`: User-Agent браузера

## Уровни логирования

- **DEBUG**: Детальная отладочная информация (не записывается в БД по умолчанию)
- **INFO**: Информационные сообщения (обычные события)
- **WARNING**: Предупреждения (некритичные проблемы)
- **ERROR**: Ошибки (проблемы, требующие внимания)
- **CRITICAL**: Критические ошибки (серьезные проблемы)

## Категории событий

- **startup**: События запуска и инициализации
- **http**: HTTP запросы и ответы
- **auth**: Аутентификация и авторизация
- **scheduler**: Планировщик задач
- **database**: Операции с базой данных (потенциально)
- **service**: Бизнес-логика сервисов (потенциально)
- **upload**: Загрузка файлов (потенциально)
- **transaction**: Работа с транзакциями (потенциально)

## Типы событий

- **system**: Системные события
- **request**: HTTP запросы
- **scheduler**: События планировщика
- **database**: События базы данных (потенциально)
- **service**: События сервисов (потенциально)

## Фильтрация и поиск

Все логи можно фильтровать по:
- Уровню логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- Типу события (system, request, scheduler и т.д.)
- Категории события (startup, http, auth и т.д.)
- Поиск по сообщению
- Диапазон дат

## Хранение

- **Системные логи**: хранятся в таблице `system_logs`
- **Действия пользователей**: хранятся в таблице `user_action_logs`
- Оба типа логов имеют индексы для быстрого поиска
- Логи можно удалять через API (только для администраторов)

## Рекомендации по расширению логирования

Для более полного аудита рекомендуется добавить логирование следующих действий:

1. **CRUD операции**:
   - Создание/обновление/удаление транзакций
   - Создание/обновление/удаление транспортных средств
   - Создание/обновление/удаление организаций
   - Создание/обновление/удаление пользователей
   - Создание/обновление/удаление провайдеров
   - Создание/обновление/удаление шаблонов

2. **Экспорт данных**:
   - Экспорт транзакций в Excel
   - Экспорт отчетов

3. **Загрузка файлов**:
   - Загрузка файлов транзакций
   - Результаты обработки файлов

4. **Изменения настроек**:
   - Изменение настроек автоматической загрузки
   - Изменение блокировки периодов

5. **Выход из системы**:
   - Явный выход пользователя (logout) - **пока логируется только на frontend, нужно добавить на backend**

## Текущее состояние логирования

### ✅ Реализовано

1. **Системные логи**:
   - ✅ Запуск и инициализация приложения
   - ✅ Все HTTP запросы (успешные и с ошибками)
   - ✅ Инициализация планировщика
   - ✅ Ошибки инициализации

2. **Действия пользователей**:
   - ✅ Успешный вход в систему
   - ✅ Неудачная попытка входа
   - ✅ Создание нового пользователя
   - ✅ Выход из системы (logout)
   - ✅ CRUD операции с организациями (create, update, delete, assign)
   - ✅ CRUD операции с пользователями (update, delete)
   - ✅ CRUD операции с провайдерами (create, update, delete)
   - ✅ CRUD операции с шаблонами (create, update, delete)
   - ✅ Операции с транзакциями (upload, delete, clear)
   - ✅ Операции с транспортными средствами (update, merge)
   - ✅ Операции с АЗС (update)
   - ✅ Операции с топливными картами (update, assign, merge)
   - ✅ Настройки системы (блокировка периода загрузки)

### ❌ Не реализовано (рекомендуется добавить)

1. **Экспорт данных**:
   - Экспорт транзакций в Excel
   - Экспорт отчетов

2. **Изменения настроек**:
   - Изменение настроек автоматической загрузки (частично - через изменение шаблонов)

3. **Просмотр данных**:
   - Просмотр детальной информации о транзакциях
   - Просмотр логов (может создавать рекурсивные логи)

## Примеры записей в логах

### Системный лог (HTTP запрос)
```json
{
  "id": 461,
  "level": "INFO",
  "message": "HTTP GET /api/v1/logs/system - 200",
  "module": "middleware",
  "function": "dispatch",
  "event_type": "request",
  "event_category": "http",
  "extra_data": "{\"method\": \"GET\", \"path\": \"/api/v1/logs/system\", \"status_code\": 200, \"client_ip\": \"127.0.0.1\", \"process_time_ms\": 45.23}",
  "created_at": "2025-12-13T10:06:46"
}
```

### Действие пользователя (Вход)
```json
{
  "id": 15,
  "user_id": 1,
  "username": "admin",
  "action_type": "login",
  "action_category": "auth",
  "action_description": "Успешный вход пользователя: admin",
  "ip_address": "127.0.0.1",
  "user_agent": "Mozilla/5.0...",
  "request_method": "POST",
  "request_path": "/api/v1/auth/login-json",
  "status": "success",
  "created_at": "2025-12-13T10:06:17"
}
```

## Статистика логирования

По умолчанию логируются:
- **Все HTTP запросы** (кроме служебных) - это может создавать большое количество записей
- **События запуска** - несколько записей при каждом старте
- **Действия аутентификации** - все попытки входа (успешные и неудачные)

**Рекомендация**: Для production можно ограничить логирование HTTP запросов только ошибками (status >= 400) для уменьшения объема логов.

## Настройка логирования

### Изменение уровня логирования HTTP запросов

В файле `backend/app/middleware/logging.py` можно изменить логирование:

**Текущая настройка**: Логируются все запросы (INFO для успешных, ERROR для ошибок)

**Для уменьшения объема логов** можно изменить строку 63:
```python
# Текущая настройка (логирует все)
log_level = "ERROR" if response.status_code >= 500 else "INFO"

# Альтернатива 1: только ошибки (>= 400)
log_level = "ERROR" if response.status_code >= 400 else None
if log_level:
    logging_service.log_system_event(...)

# Альтернатива 2: только критичные ошибки (>= 500)
log_level = "ERROR" if response.status_code >= 500 else None
if log_level:
    logging_service.log_system_event(...)
```

### Очистка старых логов

Логи можно удалять через API endpoints:
- `DELETE /api/v1/logs/system?days=90` - удалить системные логи старше 90 дней
- `DELETE /api/v1/logs/user-actions?days=90` - удалить логи действий старше 90 дней

**Примечание**: Доступно только для администраторов.
