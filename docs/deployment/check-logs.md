# Проверка логов PPR API

## Статус диагностики

✅ **API работает корректно** - тесты показывают, что:
- Сервер доступен
- Эндпоинты отвечают
- Авторизация работает
- Транзакций 0 (нормально, если в базе нет данных)

## Где искать логи

### 1. Консоль сервера FastAPI

Если сервер запущен напрямую (не через Docker), логи должны быть видны в консоли, где запущен сервер.

**Что искать:**
```
!!! MIDDLEWARE: PPR API ЗАПРОС ПОЛУЧЕН !!!
!!! PPR API: ВХОДЯЩИЙ ЗАПРОС (verify_ppr_auth) !!!
!!! PPR API: ЗАПРОС К КОРНЕВОМУ ЭНДПОИНТУ !!!
```

### 2. Docker логи

Если сервер запущен через Docker:

```powershell
# Просмотр последних 100 строк логов
docker logs gsm_backend --tail 100

# Просмотр логов в реальном времени
docker logs gsm_backend -f

# Поиск запросов PPR API
docker logs gsm_backend | Select-String "PPR API"
```

### 3. Логи в базе данных

Логи также сохраняются в таблице `system_logs`:

```sql
-- Последние 50 записей
SELECT * FROM system_logs 
ORDER BY created_at DESC 
LIMIT 50;

-- Поиск запросов PPR API
SELECT * FROM system_logs 
WHERE message LIKE '%PPR API%' 
ORDER BY created_at DESC 
LIMIT 50;
```

Или через API:

```powershell
# Получить логи через API (нужна авторизация)
$headers = @{
    "Authorization" = "Bearer YOUR_TOKEN"
}
Invoke-RestMethod -Uri "http://10.35.1.200:8000/api/v1/logs/system?search=PPR+API&limit=50" -Headers $headers
```

## Проверка запросов от 1С

### Если запросы от 1С не видны в логах:

1. **Проверьте URL в настройках 1С:**
   - Должен быть: `http://10.35.1.200:8000/api/public-api/v2`
   - Или: `https://10.35.1.200/api/public-api/v2` (если настроен HTTPS)

2. **Проверьте API ключ в 1С:**
   - Должен быть: `yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR`
   - Передается в заголовке `Authorization` БЕЗ префикса "Bearer"

3. **Проверьте сетевую доступность:**
   ```powershell
   # С сервера 1С проверьте доступность
   Test-NetConnection -ComputerName 10.35.1.200 -Port 8000
   ```

4. **Проверьте файрвол:**
   - Убедитесь, что порт 8000 открыт
   - Проверьте правила Windows Firewall

### Если запросы видны в логах, но не работают:

1. **Проверьте формат ответа:**
   - 1С ожидает поле `transactions` с английскими названиями полей
   - Проверьте, что ответ содержит все необходимые поля

2. **Проверьте авторизацию:**
   - В логах должно быть: `auth_type: api_key`
   - Если `auth_type: bearer` - проверьте, что API ключ передается правильно

## Тестирование из 1С

После запуска запроса из 1С, проверьте логи:

1. **В консоли сервера** должны появиться записи:
   ```
   !!! MIDDLEWARE: PPR API ЗАПРОС ПОЛУЧЕН !!!
   Path: /api/public-api/v2/transactions
   Method: GET
   Client IP: <IP адрес 1С>
   ```

2. **В функции verify_ppr_auth** должна быть запись:
   ```
   !!! PPR API: ВХОДЯЩИЙ ЗАПРОС (verify_ppr_auth) !!!
   Authorization header: yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR
   ```

3. **В эндпоинте транзакций** должна быть запись:
   ```
   PPR API: Запрос транзакций (оригинальный путь)
   ```

## Если логов нет вообще

1. **Проверьте, что сервер перезапущен** после изменений
2. **Проверьте, что запросы доходят до сервера:**
   - Используйте `test_ppr_debug.ps1` для проверки
   - Проверьте сетевую доступность
3. **Проверьте настройки логирования:**
   - Уровень логирования должен быть INFO или DEBUG
   - Проверьте файл `.env` или переменные окружения

## Следующие шаги

1. Запустите запрос из 1С
2. Проверьте логи сервера (консоль или Docker)
3. Если логов нет - запросы не доходят до сервера (проблема сети/файрвола)
4. Если логи есть, но ошибка - проверьте формат ответа и авторизацию

