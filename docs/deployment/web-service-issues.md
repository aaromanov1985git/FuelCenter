# Проблемы подключения к веб-сервису

## Текущая ситуация

При попытке подключения к веб-сервису `http://176.222.217.51:8080` возникает ошибка **403 Forbidden**.

## Причины ошибки 403

Ошибка 403 Forbidden может возникать по следующим причинам:

1. **Защита от ботов** - сервер может требовать выполнения JavaScript для получения токенов или валидации
2. **Проверка заголовков** - сервер может проверять специфичные заголовки, которые мы не отправляем
3. **CSRF защита** - требуется CSRF токен, который получается через JavaScript
4. **Блокировка по IP** - сервер может блокировать запросы с определенных IP адресов
5. **Проверка User-Agent и других признаков браузера** - сервер может определять, что запрос идет не из браузера

## Реализованные попытки решения

### 1. Имитация заголовков браузера
- ✅ User-Agent из реального браузера
- ✅ Origin и Referer заголовки
- ✅ Accept, Accept-Language, Accept-Encoding
- ✅ Connection: keep-alive

### 2. Работа с cookies
- ✅ Предварительный запрос к странице `/login` для получения cookies
- ✅ Автоматическое сохранение cookies между запросами

### 3. Извлечение CSRF токенов
- ✅ Парсинг HTML страницы логина для поиска CSRF токенов
- ✅ Добавление CSRF токена в заголовки запроса

### 4. Альтернативные подходы
- ✅ Прямой запрос без предварительного получения страницы
- ✅ Отправка данных как form-data вместо JSON

## Рекомендации

### Вариант 1: Использование Playwright (рекомендуется)

Если сервер требует выполнения JavaScript, необходимо использовать библиотеку для работы с браузером:

```python
# Установка: pip install playwright
# playwright install chromium

from playwright.async_api import async_playwright

async def authenticate_with_playwright(base_url, username, password):
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=True)
        context = await browser.new_context()
        page = await context.new_page()
        
        # Открываем страницу логина
        await page.goto(f"{base_url}/login")
        
        # Заполняем форму
        await page.fill('input[name="username"]', username)
        await page.fill('input[name="password"]', password)
        
        # Нажимаем кнопку входа
        await page.click('button[type="submit"]')
        
        # Ждем авторизации и получаем токен из localStorage или cookies
        await page.wait_for_url(f"{base_url}/**", timeout=10000)
        
        # Получаем токен из localStorage или cookies
        token = await page.evaluate('() => localStorage.getItem("accessToken")')
        
        await browser.close()
        return token
```

**Преимущества:**
- Полная имитация браузера
- Выполнение JavaScript
- Работа с cookies и localStorage
- Обход большинства защит от ботов

**Недостатки:**
- Требует установки браузера (Chromium)
- Больше ресурсов
- Медленнее, чем простые HTTP запросы

### Вариант 2: Использование прокси

Если проблема в блокировке по IP, можно использовать прокси:

```python
proxy = {
    "http://": "http://proxy.example.com:8080",
    "https://": "http://proxy.example.com:8080",
}

client = httpx.AsyncClient(proxies=proxy)
```

### Вариант 3: Анализ сетевых запросов

1. Откройте DevTools в браузере (F12)
2. Перейдите на вкладку Network
3. Выполните авторизацию вручную
4. Найдите запрос к `/api/auth/login`
5. Скопируйте все заголовки и параметры запроса
6. Воспроизведите их точно в коде

### Вариант 4: Обращение к администратору сервиса

Если у вас есть доступ к администратору сервиса, можно:
1. Запросить API ключ или токен для прямого доступа
2. Получить разрешение на доступ с вашего IP
3. Узнать, какие именно проверки выполняет сервер

## Текущий статус

- ✅ Добавлена поддержка типа подключения "web"
- ✅ Реализован WebAdapter с имитацией браузера
- ✅ Добавлены альтернативные подходы при ошибке 403
- ❌ Ошибка 403 Forbidden все еще возникает

## Следующие шаги

1. Проверить логи на сервере для детальной диагностики
2. Если проблема сохраняется - реализовать вариант с Playwright
3. Или обратиться к администратору сервиса для получения API доступа
