# Миграция на PPR API v1 для 1С ЕРП

## Обзор изменений

Код 1С обновлен для использования PPR API v1 вместо v2. Основные изменения:

### 1. Изменение метода запроса
- **Было**: GET-запрос с параметрами в URL
- **Стало**: POST-запрос с JSON в теле запроса

### 2. Изменение URL
- **Было**: `/api/public-api/v2/transactions?dateFrom=...&dateTo=...&format=json`
- **Стало**: `/api/public-api/v1/transaction-list`

### 3. Изменение способа передачи токена
- **Было**: Токен в заголовке `Authorization`
- **Стало**: Токен в теле запроса (поле `token`)

### 4. Изменение формата ответа
- **Было**: `СоотвИзJSON.transactions`
- **Стало**: `СоотвИзJSON["array-list"]`

## Обновленный код

### Процедура `ПолучениеТранзакцийЗаПериодППР`

```bsl
Процедура ПолучениеТранзакцийЗаПериодППР(URL, Токен, ДатаНачала, ДатаОкончания, Транзакции) Экспорт
	
	dateFrom = Формат(ДатаНачала, "ДФ=yyyy-MM-dd");
	dateTo = Формат(ДатаОкончания, "ДФ=yyyy-MM-dd");
	
	// API v1 использует POST-запрос с JSON в теле
	Ресурс = "/api/public-api/v1/transaction-list";
	Метод = "ТранзакцийЗаПериодППР";
	
	// Формируем тело запроса в формате JSON
	ТелоЗапроса = Новый Структура;
	ТелоЗапроса.Вставить("token", Токен);
	ТелоЗапроса.Вставить("dateFrom", dateFrom);
	ТелоЗапроса.Вставить("dateTo", dateTo);
	ТелоЗапроса.Вставить("format", "JSON");
	
	// Преобразуем структуру в JSON строку
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ТелоЗапроса);
	ТелоJSON = ЗаписьJSON.Закрыть();
	
	СоотвИзJSON = ВыполнитьHTTPЗапросППР_POST(URL, Ресурс, ТелоJSON, Метод);
	
	Если НЕ СоотвИзJSON = Неопределено Тогда
		// В API v1 ответ содержит поле "array-list" вместо "transactions"
		Если СоотвИзJSON.Свойство("array-list") Тогда
			МассивТранзакций = СоотвИзJSON["array-list"];
			Если МассивТранзакций.Количество() > 0 Тогда
				Для каждого ЭлТранзакции из МассивТранзакций Цикл
					НовТранзакция = Транзакции.Добавить();
					ЗаполнитьЗначенияСвойств(НовТранзакция, ЭлТранзакции);
					НовТранзакция.Дата = ПрочитатьДатуJSON(ЭлТранзакции.date, ФорматДатыJSON.ISO);
					НовТранзакция.cardNum = Формат(ЭлТранзакции.cardNum, "ЧГ=");
					Если ЭлТранзакции.TypeID = 1 Тогда
						НовТранзакция.TypeID = "Заправка";
					Иначе
						НовТранзакция.TypeID = "Возврат";
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		Иначе
			Сообщить("Ошибка: В ответе отсутствует поле 'array-list'");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры
```

### Функция `ВыполнитьHTTPЗапросППР_POST`

Новая функция для выполнения POST-запросов:

```bsl
Функция ВыполнитьHTTPЗапросППР_POST(URL, Ресурс, ТелоJSON, Метод)
	
	Попытка
		// Используем HTTPS для безопасного соединения
		ssl = Новый ЗащищенноеСоединениеOpenSSL();
		
		// Формируем заголовки запроса
		ЗаголовокЗапросаHTTP = Новый Соответствие;
		ЗаголовокЗапросаHTTP.Вставить("Content-Type", "application/json");
		ЗаголовокЗапросаHTTP.Вставить("Accept", "application/json");
		
		// Создаем HTTP-соединение (HTTPS, так как используем SSL)
		Соединение = Новый HTTPСоединение(URL, , , , , , ssl);
		
		// Создаем HTTP-запрос с методом POST
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс, ЗаголовокЗапросаHTTP);
		HTTPЗапрос.Метод = "POST";
		
		// Устанавливаем тело запроса
		HTTPЗапрос.УстановитьТелоИзСтроки(ТелоJSON);
		
		// Выполняем запрос
		Ответ = Соединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
		
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (Соединение.ВызватьHTTPМетод) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	// Проверяем код состояния ответа
	Если Ответ.КодСостояния <> 200 Тогда
		Сообщить("Ошибка работы " + Метод + " Ответ.КодСостояния <> 200 " + Ресурс + " " + Ответ.ПолучитьТелоКакСтроку());
		Возврат Неопределено;
	КонецЕсли;
	
	// Получаем тело ответа
	ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
	
	Попытка
		// Парсим JSON ответ
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		СоотвИзJSON = ПрочитатьJSON(ЧтениеJSON);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (ПрочитатьJSON) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат СоотвИзJSON;
	
КонецФункции
```

## Формат запроса

### Тело POST-запроса (JSON)

```json
{
  "token": "yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR",
  "dateFrom": "2025-12-01",
  "dateTo": "2025-12-12",
  "format": "JSON"
}
```

## Формат ответа

### Структура ответа

```json
{
  "array-list": [
    {
      "idTrans": "340022_20251201012456",
      "date": "2025-12-01T01:24:56",
      "cardNum": "226 3212",
      "TypeID": 1,
      "amount": 33.0,
      "sum": 3861.8,
      "price": 77.24,
      "serviceName": "АИ-92",
      "posAddress": "...",
      "carNumber": "...",
      ...
    }
  ]
}
```

### Важные поля

- **`amount`** - Количество (литры), НЕ сумма!
- **`sum`** - Сумма (цена * количество)
- **`price`** - Цена за литр
- **`TypeID`** - 1 = "Заправка"/"Дебет", 0 = "Возврат"/"Кредит"

## Пример использования

```bsl
// Создаем таблицу для транзакций
Транзакции = Новый ТаблицаЗначений;
Транзакции.Колонки.Добавить("Дата", Новый ОписаниеТипов("Дата"));
Транзакции.Колонки.Добавить("cardNum", Новый ОписаниеТипов("Строка"));
Транзакции.Колонки.Добавить("TypeID", Новый ОписаниеТипов("Строка"));
// ... другие колонки

// Вызываем процедуру
URL = "malignantly-meteoric-stallion.cloudpub.ru";
Токен = "yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR";
ДатаНачала = '20251201';
ДатаОкончания = '20251212';

ПолучениеТранзакцийЗаПериодППР(URL, Токен, ДатаНачала, ДатаОкончания, Транзакции);

// Обрабатываем результаты
Для каждого СтрокаТранзакции из Транзакции Цикл
	// Обработка транзакции
КонецЦикла;
```

## Отличия от API v2

| Параметр | API v2 | API v1 |
|----------|--------|--------|
| Метод | GET | POST |
| URL | `/api/public-api/v2/transactions` | `/api/public-api/v1/transaction-list` |
| Токен | В заголовке `Authorization` | В теле запроса (поле `token`) |
| Параметры | Query-параметры в URL | JSON в теле запроса |
| Ответ | `transactions` | `array-list` |

## Файлы

- **`1C_PPR_API_v1_Integration.bsl`** - Обновленный модуль интеграции с API v1
- **`PPR_API_v1_MIGRATION.md`** - Данная документация

## Примечания

1. API v1 требует HTTPS-соединение (используется SSL)
2. Токен передается в теле запроса, а не в заголовке
3. Формат ответа изменился: вместо `transactions` используется `array-list`
4. Все поля транзакций остались теми же, что и в v2

