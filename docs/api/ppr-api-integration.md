# Интеграция с 1С через эмуляцию API ППР

## Обзор

Система GSM Converter предоставляет API, которое эмулирует API ППР (поставщика процессингового центра). Это позволяет использовать существующую интеграцию 1С с ППР для работы с нашей системой без изменения кода в 1С.

## Архитектура

```
┌─────────────────────┐         ┌──────────────────────┐
│   GSM Converter     │         │   1С ERP (Рарус)     │
│   (FastAPI)         │◄────────┤  уатЗагрузкаПЦ       │
│                     │  HTTP  │                      │
│  /api/ppr/*         │  Basic │  ППР_ВыполнитьЗапрос │
│  (эмуляция ППР)     │  Auth  │  Данных              │
└─────────────────────┘         └──────────────────────┘
```

## Преимущества подхода

1. **Без изменений в 1С** - используется существующий код интеграции с ППР
2. **Простая настройка** - достаточно указать адрес нашего сервера, логин и пароль
3. **Совместимость** - полная совместимость с форматом данных ППР

## API Endpoints

### 1. Авторизация и получение токена

**URL:** `POST /api/ppr/login`

**Метод:** JSON POST запрос

**Тело запроса:**
```json
{
  "username": "admin",
  "password": "password123"
}
```

**Пример запроса:**
```bash
curl -X POST "http://localhost:8000/api/ppr/login" \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "password123"}'
```

**Формат ответа:**
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 1800,
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin",
    "is_active": true
  },
  "message": "Авторизация успешна"
}
```

**Альтернативный способ (HTTP Basic Auth):**

**URL:** `POST /api/ppr/login-basic`

**Метод авторизации:** HTTP Basic Authentication

**Заголовки:**
```
Authorization: Basic <base64(username:password)>
```

**Пример запроса:**
```bash
curl -X POST "http://localhost:8000/api/ppr/login-basic" \
  -u "username:password"
```

**Примечание:** Оба метода возвращают JWT токен для использования в последующих запросах.

### 2. Получение транзакций

**URL:** `GET /api/ppr/transaction-list`

**Метод авторизации:** Bearer Token (JWT)

**Заголовки:**
```
Authorization: Bearer <token>
```

**Параметры запроса:**
- `provider_id` (необязательный) - ID провайдера для фильтрации транзакций
- `date_from` (необязательный) - Начальная дата периода в формате `YYYY-MM-DD` или `YYYY-MM-DD HH:MM:SS`
- `date_to` (необязательный) - Конечная дата периода в формате `YYYY-MM-DD` или `YYYY-MM-DD HH:MM:SS`
- `skip` (необязательный, по умолчанию 0) - Количество записей для пропуска (пагинация)
- `limit` (необязательный, по умолчанию 1000) - Максимальное количество записей на странице (максимум 1000)

**Пример запроса:**
```bash
# Сначала получите токен через /api/ppr/login
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Затем используйте токен для запроса транзакций
curl -X GET "http://localhost:8000/api/ppr/transaction-list?provider_id=1&date_from=2025-01-01&date_to=2025-01-31" \
  -H "Authorization: Bearer $TOKEN"
```

**Формат ответа:**
```json
{
  "success": true,
  "data": [
    {
      "Дата": "2025-01-15T10:30:00",
      "Количество": 50.5,
      "МестоЗаправкиКод": "12345",
      "МестоЗаправкиНаименование": "АЗС №1, г. Москва",
      "НоменклатураОтчета": "Дизельное топливо",
      "ПластиковаяКартаОтчета": "1234567890123456",
      "ТСОтчета": "А123БВ 777",
      "Сумма": 2500.00,
      "СтавкаНДС": 20.0,
      "СуммаНДС": 416.67,
      "Лат": null,
      "Лон": null,
      "Транзакция": "123_20250115103000"
    }
  ],
  "total": 150,
  "skip": 0,
  "limit": 1000,
  "message": ""
}
```

### 3. Получение списка карт

**URL:** `GET /api/ppr/card-list`

**Метод авторизации:** Bearer Token (JWT)

**Заголовки:**
```
Authorization: Bearer <token>
```

**Параметры запроса:**
- `provider_id` (необязательный) - ID провайдера для фильтрации карт
- `skip` (необязательный, по умолчанию 0) - Количество записей для пропуска (пагинация)
- `limit` (необязательный, по умолчанию 1000) - Максимальное количество записей на странице (максимум 1000)

**Пример запроса:**
```bash
# Сначала получите токен через /api/ppr/login
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Затем используйте токен для запроса карт
curl -X GET "http://localhost:8000/api/ppr/card-list?provider_id=1" \
  -H "Authorization: Bearer $TOKEN"
```

**Формат ответа:**
```json
{
  "success": true,
  "data": [
    {
      "Идентификатор": "1",
      "Номер": "1234567890123456",
      "Статус": "Активна",
      "Владелец": "ООО Компания",
      "Провайдер": "Провайдер 1"
    }
  ],
  "total": 50,
  "skip": 0,
  "limit": 1000,
  "message": ""
}
```

### 4. Проверка работоспособности

**URL:** `GET /api/ppr/health`

**Пример запроса:**
```bash
curl -X GET "http://localhost:8000/api/ppr/health"
```

**Формат ответа:**
```json
{
  "status": "ok",
  "service": "PPR API",
  "version": "1.0"
}
```

## Настройка в 1С

### Шаг 1: Настройка API ключа в системе GSM Converter

1. Откройте веб-интерфейс системы GSM Converter
2. Перейдите в раздел "Провайдеры" → "Шаблоны"
3. Создайте или отредактируйте шаблон для вашего провайдера
4. В поле "Настройки подключения" (connection_settings) укажите JSON:
   ```json
   {
     "api_key": "yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR"
   }
   ```
   Где `yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR` - ваш API ключ

### Шаг 2: Создание учетной записи системы ПЦ в 1С

1. Откройте справочник "Учетные записи систем ПЦ"
2. Создайте новую запись:
   - **Наименование:** GSM Converter (или любое другое)
   - **Внешняя система:** ППР
   - **Адрес сервиса:** `http://10.35.1.200:8000/api/ppr` (укажите адрес вашего сервера)
   - **Ключ авторизации:** `yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR` (ваш API ключ)
   - **Логин:** можно оставить пустым (не используется при авторизации по ключу)
   - **Пароль:** можно оставить пустым (не используется при авторизации по ключу)

**Важно:** 
- При использовании API ключа логин и пароль не требуются
- Модуль 1С `уатИнтеграцияПЦППР` автоматически использует ключ из поля "КлючАвторизации"
- Ключ передается в заголовке `Authorization` напрямую, без префикса "Bearer"

### Шаг 2: Настройка параметров

В структуре параметров учетной записи укажите:
- **Организация** - ваша организация
- **Ответственный** - ответственный пользователь
- **АЗС** - основная АЗС (если требуется)
- **Создавать документы ГСМ** - флаг создания документов

### Шаг 3: Использование

Модуль 1С будет использовать существующие функции:
- `ППР_ЗагрузкаДанных` - для загрузки транзакций
- `ППР_ЗагрузкаТопливныхКарт` - для обновления карт
- `ППР_ПроверитьПодключение` - для проверки подключения

## Формат данных

### Транзакция

Структура транзакции соответствует формату, ожидаемому модулем `уатЗагрузкаПЦ`:

| Поле | Тип | Описание |
|------|-----|----------|
| `Дата` | Строка (ISO 8601) | Дата и время транзакции |
| `Количество` | Число | Количество топлива |
| `МестоЗаправкиКод` | Строка | Код АЗС |
| `МестоЗаправкиНаименование` | Строка | Наименование АЗС |
| `НоменклатураОтчета` | Строка | Наименование товара |
| `ПластиковаяКартаОтчета` | Строка | Номер карты |
| `ТСОтчета` | Строка | Транспортное средство |
| `Сумма` | Число | Сумма транзакции |
| `СтавкаНДС` | Число или null | Ставка НДС |
| `СуммаНДС` | Число | Сумма НДС |
| `Лат` | Число или null | Широта (пока не используется) |
| `Лон` | Число или null | Долгота (пока не используется) |
| `Транзакция` | Строка | Уникальный идентификатор транзакции |

### Карта

Структура карты соответствует формату ППР:

| Поле | Тип | Описание |
|------|-----|----------|
| `Идентификатор` | Строка | ID карты в системе |
| `Номер` | Строка | Номер карты |
| `Статус` | Строка | Статус карты ("Активна" или "Заблокирована") |
| `Владелец` | Строка | Владелец карты |
| `Провайдер` | Строка | Наименование провайдера |

## Маппинг данных

Данные из системы GSM Converter автоматически преобразуются в формат ППР:

### Транзакции

- `transaction_date` → `Дата`
- `quantity` → `Количество`
- `location_code` или `azs_number` → `МестоЗаправкиКод`
- `gas_station.name` или `location` или `azs_number` → `МестоЗаправкиНаименование`
- `product` → `НоменклатураОтчета`
- `card_number` → `ПластиковаяКартаОтчета`
- `vehicle` → `ТСОтчета`
- `amount_with_discount` или `amount` → `Сумма`
- `vat_rate` → `СтавкаНДС`
- `vat_amount` → `СуммаНДС`
- `id` + `transaction_date` → `Транзакция` (уникальный идентификатор)

### Карты

- `id` → `Идентификатор`
- `card_number` → `Номер`
- `is_blocked` → `Статус` ("Активна" или "Заблокирована")
- `original_owner_name` или `normalized_owner` → `Владелец`
- `provider.name` → `Провайдер`

## Примеры использования

### Пример 1: Загрузка транзакций через 1С

В модуле 1С используется стандартная функция:

```bsl
// Получаем структуру параметров
СтруктураПараметровУчетнойЗаписи = уатЗагрузкаПЦ.ПолучитьСтруктуруПараметровДляРаботыСПЦ(УчетнаяЗаписьСистемыПЦ);

// Загружаем данные (автоматически использует наш API)
ППР_ЗагрузкаДанных(СтруктураПараметровУчетнойЗаписи, ДатаНачала, ДатаОкончания, ТекущаяДата, ЕстьОшибки);
```

### Пример 2: Обновление карт через 1С

```bsl
// Получаем структуру параметров
СтруктураПараметровУчетнойЗаписи = уатЗагрузкаПЦ.ПолучитьСтруктуруПараметровДляРаботыСПЦ(УчетнаяЗаписьСистемыПЦ);

// Загружаем карты (автоматически использует наш API)
ППР_ЗагрузкаТопливныхКарт(СтруктураПараметровУчетнойЗаписи, Загружено, ТекстОшибки);
```

### Пример 3: Проверка подключения

```bsl
// Получаем структуру параметров
СтруктураПараметровУчетнойЗаписи = уатЗагрузкаПЦ.ПолучитьСтруктуруПараметровДляРаботыСПЦ(УчетнаяЗаписьСистемыПЦ);

// Проверяем подключение
Результат = ППР_ПроверитьПодключение(СтруктураПараметровУчетнойЗаписи, ДатаНачала, ДатаОкончания, ТекстОшибки);
```

## Методы авторизации

API ППР поддерживает **два метода авторизации**:

### 1. Bearer токен (JWT) - для пользователей

Используется для авторизации через логин/пароль с получением JWT токена.

**Получение токена:**
```http
POST /api/ppr/login
Content-Type: application/json

{
  "username": "admin",
  "password": "password123"
}
```

**Использование токена:**
```http
GET /api/ppr/transaction-list
Authorization: Bearer <jwt_token>
```

### 2. API ключ - для интеграции с 1С (как в оригинальном ППР)

Используется для авторизации по API ключу, как в оригинальном ППР API.

**Настройка ключа:**
1. Создайте шаблон провайдера с API ключом в `connection_settings`:
   ```json
   {
     "api_key": "yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR"
   }
   ```

2. В 1С укажите этот ключ в поле "Ключ авторизации"

**Использование ключа:**
```http
GET /api/ppr/transaction-list?provider_id=1
Authorization: yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR
```

**Важно:** Ключ передается напрямую в заголовке `Authorization`, БЕЗ префикса "Bearer".

## Безопасность

1. **JWT токены** - используется JWT (JSON Web Token) для авторизации пользователей
2. **API ключи** - хранятся в шаблонах провайдеров, проверяются при каждом запросе
3. **Время жизни токена** - токен действителен 30 минут (1800 секунд)
4. **Пароли** - пароли хранятся в безопасном хранилище 1С и никогда не передаются после получения токена
5. **Логирование** - все запросы логируются для аудита
6. **Rate Limiting** - применяются ограничения на количество запросов

## Работа с токенами

### Получение токена

1. Отправьте POST запрос на `/api/ppr/login` с логином и паролем
2. Получите JWT токен из ответа
3. Сохраните токен для использования в последующих запросах

### Использование токена

1. Добавьте токен в заголовок `Authorization` всех запросов:
   ```
   Authorization: Bearer <token>
   ```

2. Токен действителен 30 минут. После истечения срока действия получите новый токен.

### Обновление токена

Если токен истек, получите новый токен через `/api/ppr/login`.

## Обработка ошибок

API возвращает структурированные ответы с полем `success`:

- `success: true` - запрос выполнен успешно
- `success: false` - произошла ошибка, описание в поле `message`

Пример ответа с ошибкой:
```json
{
  "success": false,
  "data": [],
  "total": 0,
  "message": "Ошибка валидации: provider_id обязателен для получения данных"
}
```

## Ограничения

1. Максимальное количество записей на странице: 1000
2. Для получения больших объемов данных используйте пагинацию
3. Поля `Лат` и `Лон` пока не заполняются (зарезервированы для будущего использования)

## Поддержка

При возникновении проблем:
1. Проверьте логи API сервера
2. Убедитесь, что адрес сервера указан правильно
3. Проверьте логин и пароль
4. Убедитесь, что пользователь активен в системе
5. Проверьте, что провайдер с указанным ID существует (для транзакций)

## Версия

- API версия: 1.0
- Совместимость с 1С: 8.3.23 и выше
- Дата создания: 2025-01-27

