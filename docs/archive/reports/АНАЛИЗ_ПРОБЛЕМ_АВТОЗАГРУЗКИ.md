# Анализ проблем автоматической загрузки по расписанию и логирования событий

## Выявленные проблемы

### 1. Отсутствие логирования событий при ошибках в планировщике

**Проблема:**
- При отсутствии шаблона или его отключении события не логировались в журнал событий
- При критических ошибках в планировщике события об ошибках не фиксировались

**Исправление:**
- Добавлено логирование событий для случаев, когда шаблон не найден или отключен
- Добавлено логирование событий при критических ошибках выполнения задач планировщика
- Улучшена обработка исключений в методе `_run_auto_load_for_template`

### 2. Неполная обработка ошибок в auto_load_service

**Проблема:**
- Если переменная `result` не была определена (например, при исключении до создания результата), код в блоке `finally` мог упасть с ошибкой
- Отсутствовало детальное логирование успешного сохранения событий

**Исправление:**
- Добавлена проверка на существование `result` перед его использованием
- Улучшена обработка исключений при логировании событий
- Добавлено debug-логирование успешного сохранения событий

### 3. Проблемы с обработкой исключений в планировщике

**Проблема:**
- Отсутствовала обработка исключений в асинхронной обертке задач планировщика
- При ошибках закрытия сессий БД не было логирования

**Исправление:**
- Добавлена обработка исключений в синхронной и асинхронной обертках задач
- Добавлена обработка ошибок при закрытии сессий БД с логированием
- Улучшена диагностика проблем с планировщиком

### 4. Отсутствие rollback при ошибках сохранения событий

**Проблема:**
- При ошибках коммита событий не выполнялся rollback, что могло привести к проблемам с состоянием сессии БД

**Исправление:**
- Добавлен rollback при ошибках сохранения событий
- Улучшено логирование ошибок с указанием типа ошибки
- Добавлено debug-логирование успешного сохранения событий

### 5. Недостаточное логирование при загрузке расписаний

**Проблема:**
- Отсутствовала информация о количестве успешно загруженных и неудачных расписаний
- Не было информации, если не найдено шаблонов с расписанием

**Исправление:**
- Добавлено детальное логирование процесса загрузки расписаний
- Добавлена статистика по успешно загруженным и неудачным расписаниям
- Добавлено информационное сообщение, если не найдено шаблонов с расписанием

## Внесенные изменения

### backend/app/services/scheduler_service.py

1. **Метод `_run_auto_load_for_template`:**
   - Добавлено логирование событий для случаев, когда шаблон не найден или отключен
   - Добавлено логирование событий при критических ошибках
   - Улучшена обработка исключений при закрытии сессий БД

2. **Метод `_add_template_schedule`:**
   - Добавлена обработка исключений в синхронной и асинхронной обертках задач
   - Улучшено логирование ошибок

3. **Метод `_load_all_schedules`:**
   - Добавлена статистика по успешно загруженным и неудачным расписаниям
   - Добавлено информационное сообщение, если не найдено шаблонов
   - Улучшена обработка ошибок при закрытии сессий БД

### backend/app/services/auto_load_service.py

1. **Метод `load_template`:**
   - Добавлена проверка на существование `result` перед использованием
   - Улучшена обработка исключений при логировании событий
   - Добавлено debug-логирование успешного сохранения событий
   - Улучшена обработка сообщений об ошибках

### backend/app/services/upload_event_service.py

1. **Метод `log_event`:**
   - Добавлен rollback при ошибках сохранения событий
   - Улучшено логирование ошибок с указанием типа ошибки
   - Добавлено debug-логирование успешного сохранения событий

## Рекомендации по диагностике

### Проверка работы планировщика

1. Проверьте логи приложения при старте - должно быть сообщение:
   ```
   "Планировщик задач автоматической загрузки запущен"
   "Загрузка расписаний автоматической загрузки"
   "Расписания автоматической загрузки загружены"
   ```

2. Проверьте наличие задач в планировщике через API (если есть такой endpoint) или логи:
   ```
   "Добавлено расписание для шаблона"
   ```

3. Проверьте журнал событий (`upload_events`) на наличие записей с `is_scheduled=True`

### Проверка логирования событий

1. Все события автоматической загрузки должны иметь:
   - `source_type="auto"`
   - `is_scheduled=True`
   - `username="system"`

2. При ошибках должны создаваться события со статусом `status="failed"` и сообщением об ошибке

3. Проверьте логи на наличие сообщений:
   - "Событие автозагрузки успешно зафиксировано в журнале"
   - "Не удалось зафиксировать событие автозагрузки в журнале" (при ошибках)

### Возможные причины отсутствия логов

1. **Планировщик не запускается:**
   - Проверьте логи при старте приложения на наличие ошибок инициализации
   - Проверьте, что планировщик запущен: `scheduler.running == True`

2. **Нет шаблонов с расписанием:**
   - Проверьте, что есть шаблоны с `auto_load_enabled=True` и `auto_load_schedule IS NOT NULL`
   - Проверьте логи на сообщение "Не найдено шаблонов с настроенным расписанием"

3. **Ошибки при сохранении событий:**
   - Проверьте логи на наличие ошибок "Не удалось записать событие загрузки в журнал"
   - Проверьте подключение к БД и права доступа

4. **Ошибки парсинга расписания:**
   - Проверьте формат расписания в шаблонах
   - Проверьте логи на наличие ошибок "Ошибка при парсинге расписания"

## Проблема с системными логами

### Выявленная проблема

**Проблема:**
- В интерфейсе отображается "Логи не найдены" в разделе "Системные логи"
- Логи не сохранялись в базу данных, хотя API endpoint и модель SystemLog существовали
- Роутер для логов не был подключен к приложению
- Логирование было настроено только для вывода в консоль, без сохранения в БД

**Исправление:**

1. **Подключение роутера логов:**
   - Добавлен `app.include_router(logs.router)` в `main.py`

2. **Создание DatabaseHandler:**
   - Создан класс `DatabaseLogHandler` для сохранения логов в таблицу `system_logs`
   - Handler автоматически определяет `event_type` и `event_category` на основе имени логгера и модуля
   - Сохраняет информацию об исключениях (тип, сообщение, трассировка стека)
   - Сохраняет дополнительные данные из `extra` в формате JSON

3. **Настройка логирования:**
   - DatabaseHandler настроен на сохранение логов уровня WARNING и выше
   - Это предотвращает перегрузку БД избыточными DEBUG/INFO логами
   - Handler обрабатывает ошибки gracefully, не нарушая работу приложения

### Внесенные изменения

#### backend/app/main.py
- Добавлен `app.include_router(logs.router)` для подключения роутера системных логов

#### backend/app/logger.py
- Создан класс `DatabaseLogHandler` для сохранения логов в БД
- Добавлена автоматическая настройка `event_type` и `event_category`
- Добавлена обработка исключений с сохранением трассировки стека
- DatabaseHandler добавлен к logger с уровнем WARNING

## Дополнительные улучшения

Для дальнейшей диагностики рекомендуется:

1. Добавить endpoint для проверки статуса планировщика и списка задач
2. Добавить метрики по количеству успешных/неудачных автоматических загрузок
3. Добавить уведомления администраторам при критических ошибках планировщика
4. Добавить возможность ручного запуска автоматической загрузки для тестирования
5. Рассмотреть возможность добавления фильтрации логов по уровню в настройках (например, сохранять INFO для определенных категорий)
