# Устранение проблем с PPR API

## Ошибка "Couldn't resolve host name"

### Причина
Ошибка возникает, когда модуль 1С не может разрешить имя хоста или неправильно формирует URL запроса.

### Решения

#### 1. Проверка формирования URL в модуле 1С

Убедитесь, что URL формируется правильно:

```bsl
URL = "http://10.35.1.200:8000";
Ресурс = "/api/public-api/v2/transactions?dateFrom="+dateFrom+"&dateTo="+dateTo+"&format=json";

// Правильный способ формирования полного URL
ПолныйURL = URL + Ресурс;
```

**Важно:** 
- Не используйте пробелы в URL
- Убедитесь, что порт указан правильно (8000)
- Проверьте, что IP-адрес доступен из 1С

#### 2. Использование HTTPСоединение правильно

```bsl
// Создаем соединение с базовым URL (без пути)
Соединение = Новый HTTPСоединение("10.35.1.200", 8000);

// Формируем запрос с полным путем
Запрос = Новый HTTPЗапрос(Ресурс);  // Ресурс = "/api/public-api/v2/transactions?..."
Запрос.Заголовки.Вставить("Authorization", Токен);
Запрос.Заголовки.Вставить("Content-Type", "application/json");
Запрос.Заголовки.Вставить("Accept", "application/json");

// Выполняем запрос
HTTPСервисОтвет = Соединение.Получить(Запрос);
```

#### 3. Альтернативный способ - использование полного URL

```bsl
// Если HTTPСоединение не работает, используйте полный URL
ПолныйURL = "http://10.35.1.200:8000/api/public-api/v2/transactions?dateFrom="+dateFrom+"&dateTo="+dateTo+"&format=json";

// Создаем соединение без указания порта (используется по умолчанию)
Соединение = Новый HTTPСоединение("10.35.1.200", 8000);
Запрос = Новый HTTPЗапрос(ПолныйURL);
```

#### 4. Проверка доступности сервера

Проверьте доступность сервера из 1С:

```bsl
Попытка
    Соединение = Новый HTTPСоединение("10.35.1.200", 8000);
    Запрос = Новый HTTPЗапрос("/api/public-api/v2");
    HTTPСервисОтвет = Соединение.Получить(Запрос);
    
    Если HTTPСервисОтвет.КодСостояния = 200 Тогда
        Сообщить("Сервер доступен");
    Иначе
        Сообщить("Ошибка: " + Формат(HTTPСервисОтвет.КодСостояния, "ЧГ="));
    КонецЕсли;
Исключение
    Сообщить("Ошибка подключения: " + ОписаниеОшибки());
КонецПопытки;
```

#### 5. Использование прокси (если требуется)

Если 1С работает через прокси:

```bsl
Прокси = Новый ИнтернетПрокси;
Прокси.Установить("http://прокси-сервер:порт", "логин", "пароль");

Соединение = Новый HTTPСоединение("10.35.1.200", 8000, Прокси);
```

## Поддерживаемые параметры запроса

### Параметры даты (оба варианта поддерживаются):

- `date_from` / `dateFrom` - Начальная дата (YYYY-MM-DD)
- `date_to` / `dateTo` - Конечная дата (YYYY-MM-DD)

### Другие параметры:

- `provider_id` - ID провайдера (опционально)
- `skip` - Количество записей для пропуска (по умолчанию 0)
- `limit` - Максимальное количество записей (по умолчанию 1000, максимум 1000)
- `format` - Формат ответа (json, xml) - для совместимости, всегда возвращается JSON

## Примеры правильных запросов

### Вариант 1: С параметрами dateFrom/dateTo (camelCase)

```
GET /api/public-api/v2/transactions?dateFrom=2025-12-01&dateTo=2025-12-20&format=json
Authorization: yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR
```

### Вариант 2: С параметрами date_from/date_to (snake_case)

```
GET /api/public-api/v2/transactions?date_from=2025-12-01&date_to=2025-12-20
Authorization: yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR
```

## Формат ответа

API возвращает транзакции в нескольких форматах для совместимости:

```json
{
  "success": true,
  "Успех": true,
  "transactions": [
    {
      "date": "2025-12-01T10:30:00",
      "cardNum": "1234567890123456",
      "TypeID": 1
    }
  ],
  "Транзакции": [
    {
      "Дата": "2025-12-01T10:30:00",
      "Количество": 50.5,
      "МестоЗаправкиКод": "12345",
      "МестоЗаправкиНаименование": "АЗС №1",
      "НоменклатураОтчета": "Дизельное топливо",
      "ПластиковаяКартаОтчета": "1234567890123456",
      "ТСОтчета": "А123БВ 777",
      "Сумма": 2500.00,
      "Транзакция": "12345_20251201103000"
    }
  ],
  "total": 100,
  "ВсегоЗаписей": 100
}
```

## Проверка работы API

### Через PowerShell:

```powershell
$apiKey = "yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR"
$headers = @{
    Authorization = $apiKey
}

# Проверка доступности
Invoke-RestMethod -Uri "http://10.35.1.200:8000/api/public-api/v2" -Method Get -Headers $headers

# Получение транзакций
Invoke-RestMethod -Uri "http://10.35.1.200:8000/api/public-api/v2/transactions?dateFrom=2025-12-01&dateTo=2025-12-20&format=json" -Method Get -Headers $headers
```

### Через curl:

```bash
curl -X GET "http://10.35.1.200:8000/api/public-api/v2/transactions?dateFrom=2025-12-01&dateTo=2025-12-20&format=json" \
  -H "Authorization: yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR"
```

## Частые ошибки

### 1. "Couldn't resolve host name"
- Проверьте правильность IP-адреса
- Убедитесь, что сервер доступен из сети 1С
- Проверьте настройки файрвола

### 2. "Connection refused"
- Проверьте, что сервер запущен
- Убедитесь, что порт 8000 открыт
- Проверьте настройки брандмауэра

### 3. "401 Unauthorized"
- Проверьте правильность API ключа
- Убедитесь, что ключ сохранен в шаблоне провайдера
- Проверьте формат заголовка Authorization (без "Bearer")

### 4. "404 Not Found"
- Проверьте правильность пути `/api/public-api/v2/transactions`
- Убедитесь, что используется правильный префикс API

