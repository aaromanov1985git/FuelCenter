# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è:
- –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–π –¢–°
- –ü—Ä–æ–±–µ–≥–∞
- –§–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–∞–≤–æ–∫
- –î—Ä—É–≥–∏—Ö —Ç–µ–ª–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** ‚Äî –∫–∞–∂–¥—ã–π –∞–¥–∞–ø—Ç–µ—Ä –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω
2. **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è** ‚Äî –µ–¥–∏–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
3. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** ‚Äî –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã
4. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry
5. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°

## üìê –î–∏–∞–≥—Ä–∞–º–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —è–¥—Ä–æ                   ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ         IMonitoringAdapter (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - get_positions(vehicle_id, start, end)        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - get_odometer(vehicle_id, timestamp)          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - get_refuel_events(vehicle_id, period)         ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                          ‚ñ≤                              ‚îÇ
‚îÇ                          ‚îÇ implements                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                  ‚îÇ                  ‚îÇ
        ‚ñº                  ‚ñº                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ê–≤—Ç–æ–≥—Ä–∞—Ñ     ‚îÇ  ‚îÇ Wialon       ‚îÇ  ‚îÇ GLONASS      ‚îÇ
‚îÇ –ê–¥–∞–ø—Ç–µ—Ä      ‚îÇ  ‚îÇ –ê–¥–∞–ø—Ç–µ—Ä      ‚îÇ  ‚îÇ –ê–¥–∞–ø—Ç–µ—Ä      ‚îÇ
‚îÇ (—ç—Ç–∞–ø 1)     ‚îÇ  ‚îÇ (—ç—Ç–∞–ø 2)     ‚îÇ  ‚îÇ (—ç—Ç–∞–ø 2)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                  ‚îÇ                  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  TelemetryEvent        ‚îÇ
              ‚îÇ  (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)     ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–∞–ø—Ç–µ—Ä–∞

### –ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

```python
from abc import ABC, abstractmethod
from datetime import datetime
from typing import List, Optional
from app.models.telemetry_event import TelemetryEvent

class IMonitoringAdapter(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ —Å–∏—Å—Ç–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"""
    
    @abstractmethod
    def get_positions(
        self, 
        vehicle_id: str, 
        start: datetime, 
        end: datetime
    ) -> List[TelemetryEvent]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–π –¢–° –∑–∞ –ø–µ—Ä–∏–æ–¥
        
        Args:
            vehicle_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¢–° –≤ —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            start: –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞
            end: –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π —Å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è–º–∏
        """
        pass
    
    @abstractmethod
    def get_odometer(
        self, 
        vehicle_id: str, 
        timestamp: datetime
    ) -> Optional[float]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–±–µ–≥ –¢–° –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
        
        Args:
            vehicle_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¢–°
            timestamp: –ú–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
        
        Returns:
            –ü—Ä–æ–±–µ–≥ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö –∏–ª–∏ None
        """
        pass
    
    @abstractmethod
    def get_refuel_events(
        self, 
        vehicle_id: str, 
        start: datetime, 
        end: datetime
    ) -> List[TelemetryEvent]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–∞–≤–∫–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        
        Args:
            vehicle_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¢–°
            start: –ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞
            end: –ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –∑–∞–ø—Ä–∞–≤–æ–∫
        """
        pass
    
    @abstractmethod
    def test_connection(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        
        Returns:
            True –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
        """
        pass
```

## üì¶ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### TelemetryEvent

```python
from dataclasses import dataclass
from datetime import datetime
from typing import Optional, Literal

@dataclass
class TelemetryEvent:
    """–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–±—ã—Ç–∏—è"""
    
    vehicle_id: str
    timestamp: datetime
    lat: float
    lon: float
    odometer_km: Optional[float] = None
    speed_kmh: Optional[float] = None
    heading: Optional[float] = None
    accuracy_m: Optional[float] = None
    event_type: Literal["movement", "refuel", "idle", "stop"] = "movement"
    source_system: str  # "–ê–≤—Ç–æ–≥—Ä–∞—Ñ", "Wialon", "GLONASS"
    source_event_id: Optional[str] = None  # ID —Å–æ–±—ã—Ç–∏—è –≤ –∏—Å—Ö–æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
    fuel_level_percent: Optional[float] = None
    additional_data: Optional[dict] = None  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞ "–ê–≤—Ç–æ–≥—Ä–∞—Ñ"

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–∞

```python
import requests
from datetime import datetime, timedelta
from typing import List, Optional
from app.adapters.base_adapter import IMonitoringAdapter
from app.models.telemetry_event import TelemetryEvent
from app.logger import logger
import time

class AutographAdapter(IMonitoringAdapter):
    """–ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ '–ê–≤—Ç–æ–≥—Ä–∞—Ñ' –æ—Ç –¢–µ—Ö–Ω–æ–∫–æ–º"""
    
    def __init__(
        self, 
        base_url: str,
        username: str,
        password: str,
        timeout: int = 30,
        retry_count: int = 3
    ):
        self.base_url = base_url.rstrip('/')
        self.username = username
        self.password = password
        self.timeout = timeout
        self.retry_count = retry_count
        self.session = requests.Session()
        self._auth_token = None
    
    def _authenticate(self) -> bool:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ API –ê–≤—Ç–æ–≥—Ä–∞—Ñ–∞"""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
        pass
    
    def _make_request(
        self, 
        method: str, 
        endpoint: str, 
        **kwargs
    ) -> requests.Response:
        """–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å retry –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
        for attempt in range(self.retry_count):
            try:
                if not self._auth_token:
                    self._authenticate()
                
                url = f"{self.base_url}/{endpoint.lstrip('/')}"
                response = self.session.request(
                    method=method,
                    url=url,
                    timeout=self.timeout,
                    headers={
                        "Authorization": f"Bearer {self._auth_token}",
                        "Content-Type": "application/json"
                    },
                    **kwargs
                )
                response.raise_for_status()
                return response
                
            except requests.exceptions.RequestException as e:
                logger.warning(
                    f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ê–≤—Ç–æ–≥—Ä–∞—Ñ—É (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}): {e}"
                )
                if attempt < self.retry_count - 1:
                    time.sleep(2 ** attempt)  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                else:
                    raise
    
    def get_positions(
        self, 
        vehicle_id: str, 
        start: datetime, 
        end: datetime
    ) -> List[TelemetryEvent]:
        """–ü–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –¢–°"""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞
        pass
    
    def get_odometer(
        self, 
        vehicle_id: str, 
        timestamp: datetime
    ) -> Optional[float]:
        """–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–±–µ–≥ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏"""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
        pass
    
    def get_refuel_events(
        self, 
        vehicle_id: str, 
        start: datetime, 
        end: datetime
    ) -> List[TelemetryEvent]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–∞–≤–∫–∏"""
        # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
        pass
    
    def test_connection(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"""
        try:
            self._authenticate()
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ê–≤—Ç–æ–≥—Ä–∞—Ñ—É: {e}")
            return False
```

## üîó –°—Ö–µ–º–∞ —Å–≤—è–∑–∏ "–ö–∞—Ä—Ç–∞ ‚Üí –¢–°"

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

```python
class CardVehicleAssignment(Base):
    """–ü—Ä–∏–≤—è–∑–∫–∞ —Ç–æ–ø–ª–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã –∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–º—É —Å—Ä–µ–¥—Å—Ç–≤—É —Å –∏—Å—Ç–æ—Ä–∏–µ–π"""
    
    __tablename__ = "card_vehicle_assignments"
    
    id = Column(Integer, primary_key=True)
    card_id = Column(Integer, ForeignKey("fuel_cards.id"), nullable=False)
    vehicle_id = Column(Integer, ForeignKey("vehicles.id"), nullable=False)
    valid_from = Column(DateTime, nullable=False)
    valid_to = Column(DateTime, nullable=True)  # NULL = –∞–∫—Ç–∏–≤–Ω–∞
    assigned_by = Column(String(100))  # –ö—Ç–æ –Ω–∞–∑–Ω–∞—á–∏–ª
    notes = Column(Text)  # –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
    created_at = Column(DateTime, server_default=func.now())
    
    # –ò–Ω–¥–µ–∫—Å—ã
    __table_args__ = (
        Index('idx_card_vehicle_active', 'card_id', 'valid_from', 'valid_to'),
        Index('idx_card_vehicle_vehicle', 'vehicle_id'),
    )
```

### –ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã

```python
def get_active_vehicle_for_card(
    db: Session,
    card_id: int,
    date: datetime
) -> Optional[Vehicle]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –¢–° –¥–ª—è –∫–∞—Ä—Ç—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É
    
    Args:
        db: –°–µ—Å—Å–∏—è –ë–î
        card_id: ID –∫–∞—Ä—Ç—ã
        date: –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    Returns:
        Vehicle –∏–ª–∏ None
    """
    assignment = db.query(CardVehicleAssignment).filter(
        CardVehicleAssignment.card_id == card_id,
        CardVehicleAssignment.valid_from <= date,
        or_(
            CardVehicleAssignment.valid_to >= date,
            CardVehicleAssignment.valid_to.is_(None)
        )
    ).order_by(
        CardVehicleAssignment.valid_from.desc()
    ).first()
    
    if assignment:
        return db.query(Vehicle).filter(
            Vehicle.id == assignment.vehicle_id
        ).first()
    
    return None
```

## üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

### –ü—Å–µ–≤–¥–æ–∫–æ–¥

```
–î–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
  1. –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–µ –¢–° (–ø–æ –∫–∞—Ä—Ç–µ –∏ –¥–∞—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
  2. –ï—Å–ª–∏ –¢–° –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí —Å—Ç–∞—Ç—É—Å "no_vehicle"
  3. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é –∑–∞ –ø–µ—Ä–∏–æ–¥ ¬±15 –º–∏–Ω—É—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  4. –ï—Å–ª–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Üí —Å—Ç–∞—Ç—É—Å "no_telemetry"
  5. –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–µ–µ —Å–æ–±—ã—Ç–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  6. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Üí —Å—Ç–∞—Ç—É—Å "ambiguous"
  7. –í—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –¢–° –¥–æ –ê–ó–° (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
  8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–ø—Ä–∞–≤–∫–∏ –≤ —Ç–µ–ª–µ–º–∞—Ç–∏–∫–µ
  9. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–æ–≥–∞—â—ë–Ω–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
def enrich_transaction(
    self,
    transaction: Transaction,
    adapter: IMonitoringAdapter
) -> EnrichedFuelTransaction:
    """–û–±–æ–≥–∞—Ç–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ç–µ–ª–µ–º–∞—Ç–∏–∫–∏"""
    
    # 1. –ü–æ–ª—É—á–∏—Ç—å –¢–°
    vehicle = get_active_vehicle_for_card(
        self.db, 
        transaction.card_id, 
        transaction.transaction_date
    )
    
    if not vehicle:
        return self._create_enriched_with_status(
            transaction, 
            "no_vehicle"
        )
    
    # 2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é
    time_window = timedelta(minutes=15)
    start = transaction.transaction_date - time_window
    end = transaction.transaction_date + time_window
    
    try:
        positions = adapter.get_positions(
            vehicle.external_id,  # ID –≤ —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            start,
            end
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏: {e}")
        return self._create_enriched_with_status(
            transaction,
            "telemetry_error"
        )
    
    if not positions:
        return self._create_enriched_with_status(
            transaction,
            "no_telemetry"
        )
    
    # 3. –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–µ–µ —Å–æ–±—ã—Ç–∏–µ
    best_match = min(
        positions,
        key=lambda p: abs(
            (p.timestamp - transaction.transaction_date).total_seconds()
        )
    )
    
    time_diff = abs(
        (best_match.timestamp - transaction.transaction_date).total_seconds()
    )
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∑–∞–ø—Ä–∞–≤–∫—É
    refuel_events = adapter.get_refuel_events(
        vehicle.external_id,
        start,
        end
    )
    
    refuel_confirmed = any(
        abs((r.timestamp - transaction.transaction_date).total_seconds()) < 300
        for r in refuel_events
    )
    
    # 5. –í—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ê–ó–°
    distance = None
    if transaction.gas_station and transaction.gas_station.latitude:
        distance = calculate_distance_haversine(
            transaction.gas_station.latitude,
            transaction.gas_station.longitude,
            best_match.lat,
            best_match.lon
        )
    
    # 6. –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–±–µ–≥
    odometer = adapter.get_odometer(
        vehicle.external_id,
        transaction.transaction_date
    )
    
    # 7. –°–æ–∑–¥–∞—Ç—å –æ–±–æ–≥–∞—â—ë–Ω–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    return EnrichedFuelTransaction(
        transaction_id=transaction.id,
        card_id=transaction.card_id,
        vehicle_id=vehicle.id,
        transaction_ts=transaction.transaction_date,
        volume_l=transaction.quantity,
        amount_rub=transaction.amount,
        azs_name=transaction.gas_station.name if transaction.gas_station else None,
        azs_lat=transaction.gas_station.latitude if transaction.gas_station else None,
        azs_lon=transaction.gas_station.longitude if transaction.gas_station else None,
        telemetry_lat=best_match.lat,
        telemetry_lon=best_match.lon,
        distance_from_azs_m=distance,
        odometer_km=odometer,
        refuel_confirmed=refuel_confirmed,
        time_diff_seconds=int(time_diff),
        matching_status="matched",
        matching_details={
            "candidates_count": len(positions),
            "best_time_diff_sec": int(time_diff),
            "refuel_events_count": len(refuel_events)
        }
    )
```

## üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ config.py

```python
class Settings(BaseSettings):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
    
    # –ê–≤—Ç–æ–≥—Ä–∞—Ñ –¢–µ—Ö–Ω–æ–∫–æ–º
    AUTOGRAPH_BASE_URL: str = "https://api.autograph.technocom.ru"
    AUTOGRAPH_USERNAME: str = ""
    AUTOGRAPH_PASSWORD: str = ""
    AUTOGRAPH_TIMEOUT: int = 30
    AUTOGRAPH_RETRY_COUNT: int = 3
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    MATCHING_TIME_WINDOW_MINUTES: int = 15
    MATCHING_MAX_DISTANCE_METERS: int = 500
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

```python
# backend/scripts/test_autograph_integration.py

from app.adapters.autograph_adapter import AutographAdapter
from app.config import get_settings
from datetime import datetime, timedelta

settings = get_settings()

adapter = AutographAdapter(
    base_url=settings.AUTOGRAPH_BASE_URL,
    username=settings.AUTOGRAPH_USERNAME,
    password=settings.AUTOGRAPH_PASSWORD
)

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if adapter.test_connection():
    print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ")
else:
    print("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
    exit(1)

# –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
vehicle_id = "TEST_VEHICLE_ID"
end = datetime.now()
start = end - timedelta(days=1)

positions = adapter.get_positions(vehicle_id, start, end)
print(f"–ü–æ–ª—É—á–µ–Ω–æ {len(positions)} –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–π")

odometer = adapter.get_odometer(vehicle_id, end)
print(f"–ü—Ä–æ–±–µ–≥: {odometer} –∫–º")

refuels = adapter.get_refuel_events(vehicle_id, start, end)
print(f"–ó–∞–ø—Ä–∞–≤–æ–∫: {len(refuels)}")
```

## üìù –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `IMonitoringAdapter`
- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å `TelemetryEvent`
- [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∞–¥–∞–ø—Ç–µ—Ä "–ê–≤—Ç–æ–≥—Ä–∞—Ñ" –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ retry
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ API

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-20  
**–°—Ç–∞—Ç—É—Å:** –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
