# Проектирование сервиса "Анализ топливных карт"

## 1. Общее описание

Сервис предназначен для комплексного анализа данных по топливным картам, включая:
- Сопоставление транзакций по картам с фактическими заправками ТС
- Проверку геолокации ТС в момент заправки (наличие в радиусе АЗС)
- Выявление аномалий и несоответствий
- Анализ паттернов использования карт

## 2. Архитектура данных

### 2.1. Новые модели данных

#### 2.1.1. VehicleRefuel (Заправки ТС)
Хранит данные о фактических заправках транспортных средств, полученные из внешних систем (GLONASS, телематика и т.д.)

**Поля:**
- `id` - первичный ключ
- `vehicle_id` - ID транспортного средства
- `refuel_date` - дата и время заправки
- `fuel_type` - тип топлива
- `quantity` - количество заправленного топлива (литры)
- `fuel_level_before` - уровень топлива до заправки (% или литры)
- `fuel_level_after` - уровень топлива после заправки (% или литры)
- `odometer_reading` - показания одометра на момент заправки
- `source_system` - источник данных (GLONASS, телематика, ручной ввод)
- `source_id` - ID записи в системе-источнике
- `latitude` - широта места заправки (если доступна)
- `longitude` - долгота места заправки (если доступна)
- `location_accuracy` - точность определения местоположения (метры)
- `created_at` - дата создания записи
- `updated_at` - дата обновления записи

#### 2.1.2. VehicleLocation (Местоположения ТС)
Хранит историю местоположений транспортных средств по данным GLONASS/GPS

**Поля:**
- `id` - первичный ключ
- `vehicle_id` - ID транспортного средства
- `timestamp` - дата и время фиксации местоположения
- `latitude` - широта
- `longitude` - долгота
- `speed` - скорость движения (км/ч)
- `heading` - направление движения (градусы)
- `accuracy` - точность определения местоположения (метры)
- `source` - источник данных (GLONASS, GPS, телематика)
- `created_at` - дата создания записи

**Индексы:**
- `idx_vehicle_location_vehicle_timestamp` - (vehicle_id, timestamp) для быстрого поиска по ТС и времени

#### 2.1.3. FuelCardAnalysisResult (Результаты анализа)
Хранит результаты анализа соответствия транзакций и заправок

**Поля:**
- `id` - первичный ключ
- `transaction_id` - ID транзакции по карте
- `refuel_id` - ID заправки ТС (если найдено соответствие)
- `fuel_card_id` - ID топливной карты
- `vehicle_id` - ID транспортного средства
- `analysis_date` - дата проведения анализа
- `match_status` - статус соответствия:
  - `matched` - найдено соответствие
  - `no_refuel` - нет данных о заправке
  - `location_mismatch` - ТС не было в радиусе АЗС
  - `quantity_mismatch` - несоответствие количества топлива
  - `time_mismatch` - несоответствие времени
  - `multiple_matches` - найдено несколько возможных соответствий
- `match_confidence` - уверенность в соответствии (0-100%)
- `distance_to_azs` - расстояние от ТС до АЗС в момент транзакции (метры)
- `time_difference` - разница во времени между транзакцией и заправкой (секунды)
- `quantity_difference` - разница в количестве топлива (литры)
- `analysis_details` - JSON с детальной информацией об анализе
- `is_anomaly` - флаг аномалии (требует внимания)
- `anomaly_type` - тип аномалии:
  - `fuel_theft` - возможная кража топлива
  - `card_misuse` - неправильное использование карты
  - `data_error` - ошибка в данных
  - `equipment_failure` - сбой оборудования
- `created_at` - дата создания записи
- `updated_at` - дата обновления записи

## 3. Функциональность сервиса

### 3.1. Основные функции анализа

#### 3.1.1. Сопоставление транзакций и заправок
- Поиск заправок ТС, соответствующих транзакциям по карте
- Критерии соответствия:
  - Временное окно: ±30 минут от времени транзакции (настраиваемо)
  - Количество топлива: ±5% от количества в транзакции (настраиваемо)
  - Тип топлива: должен совпадать
  - ТС: должно быть закреплено за картой на момент транзакции

#### 3.1.2. Проверка геолокации
- Определение местоположения ТС в момент транзакции
- Проверка нахождения ТС в радиусе АЗС:
  - Радиус по умолчанию: 500 метров (настраиваемо)
  - Учитывается точность определения местоположения
  - Учитывается время между фиксацией местоположения и транзакцией

#### 3.1.3. Выявление аномалий
- **Кража топлива:**
  - Транзакция есть, заправки нет
  - ТС не было в радиусе АЗС
  - Значительное превышение количества топлива в транзакции над фактической заправкой
  
- **Неправильное использование карты:**
  - Транзакция по карте, закрепленной за другим ТС
  - Множественные транзакции в короткий период времени
  
- **Ошибки данных:**
  - Несоответствие типов топлива
  - Нереалистичные значения количества топлива
  - Отсутствие данных о местоположении АЗС

#### 3.1.4. Анализ паттернов
- Частота использования карт
- Средний объем заправок
- Предпочтительные АЗС
- Время заправок (дневное/ночное)
- География использования карт

### 3.2. API эндпоинты

#### 3.2.1. Анализ конкретной транзакции
```
POST /api/fuel-card-analysis/analyze-transaction/{transaction_id}
```
Анализирует конкретную транзакцию и возвращает результат анализа.

#### 3.2.2. Анализ транзакций по карте
```
POST /api/fuel-card-analysis/analyze-card/{card_id}
```
Анализирует все транзакции по указанной карте за период.

#### 3.2.3. Анализ транзакций за период
```
POST /api/fuel-card-analysis/analyze-period
Body: {
  "date_from": "2025-01-01T00:00:00",
  "date_to": "2025-01-31T23:59:59",
  "card_ids": [1, 2, 3],  // опционально
  "vehicle_ids": [1, 2, 3],  // опционально
  "organization_ids": [1, 2, 3]  // опционально
}
```
Массовый анализ транзакций за период с фильтрацией.

#### 3.2.4. Получение результатов анализа
```
GET /api/fuel-card-analysis/results
Query params:
  - transaction_id
  - card_id
  - vehicle_id
  - match_status
  - is_anomaly
  - date_from
  - date_to
  - skip, limit
```
Получение сохраненных результатов анализа с фильтрацией.

#### 3.2.5. Статистика по аномалиям
```
GET /api/fuel-card-analysis/anomalies/stats
Query params:
  - date_from
  - date_to
  - organization_id
  - anomaly_type
```
Получение статистики по аномалиям.

#### 3.2.6. Загрузка данных о заправках
```
POST /api/fuel-card-analysis/refuels/upload
Body: {
  "refuels": [
    {
      "vehicle_id": 1,
      "refuel_date": "2025-01-15T10:30:00",
      "fuel_type": "Дизельное топливо",
      "quantity": 50.5,
      "fuel_level_before": 20,
      "fuel_level_after": 80,
      "odometer_reading": 150000,
      "latitude": 55.7558,
      "longitude": 37.6173,
      "source_system": "GLONASS"
    }
  ]
}
```
Загрузка данных о заправках ТС.

#### 3.2.7. Загрузка данных о местоположениях
```
POST /api/fuel-card-analysis/locations/upload
Body: {
  "locations": [
    {
      "vehicle_id": 1,
      "timestamp": "2025-01-15T10:30:00",
      "latitude": 55.7558,
      "longitude": 37.6173,
      "speed": 60,
      "heading": 90,
      "accuracy": 10,
      "source": "GLONASS"
    }
  ]
}
```
Загрузка данных о местоположениях ТС.

## 4. Алгоритмы анализа

### 4.1. Алгоритм сопоставления транзакции и заправки

1. **Получение данных:**
   - Транзакция по карте
   - ТС, закрепленное за картой на момент транзакции
   - АЗС, где была транзакция (координаты)
   - Заправки ТС в временном окне (±30 минут)
   - Местоположения ТС в временном окне

2. **Поиск заправок:**
   - Фильтр по ТС
   - Фильтр по времени: `refuel_date` в диапазоне `transaction_date ± 30 минут`
   - Фильтр по типу топлива: должен совпадать с `product` в транзакции
   - Фильтр по количеству: `quantity` в диапазоне `transaction.quantity ± 5%`

3. **Проверка геолокации:**
   - Найти ближайшее местоположение ТС к времени транзакции
   - Вычислить расстояние от ТС до АЗС (формула гаверсинуса)
   - Проверить, находится ли ТС в радиусе АЗС (500 м по умолчанию)
   - Учесть точность определения местоположения

4. **Оценка соответствия:**
   - Если найдена одна заправка и ТС в радиусе → `matched` (confidence 90-100%)
   - Если найдена одна заправка, но ТС не в радиусе → `location_mismatch` (confidence 70-80%)
   - Если найдено несколько заправок → `multiple_matches` (confidence 50-70%)
   - Если заправка не найдена, но ТС в радиусе → `no_refuel` (confidence 30-50%)
   - Если заправка не найдена и ТС не в радиусе → `no_refuel` + аномалия (confidence 10-30%)

### 4.2. Формула расчета расстояния (Гаверсинус)

```python
import math

def calculate_distance(lat1, lon1, lat2, lon2):
    """
    Вычисляет расстояние между двумя точками на Земле в метрах
    Использует формулу гаверсинуса
    """
    R = 6371000  # Радиус Земли в метрах
    
    phi1 = math.radians(lat1)
    phi2 = math.radians(lat2)
    delta_phi = math.radians(lat2 - lat1)
    delta_lambda = math.radians(lon2 - lon1)
    
    a = math.sin(delta_phi/2)**2 + \
        math.cos(phi1) * math.cos(phi2) * math.sin(delta_lambda/2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    
    distance = R * c
    return distance
```

## 5. Настройки анализа

### 5.1. Параметры по умолчанию
- Временное окно для сопоставления: ±30 минут
- Допустимое отклонение количества: ±5%
- Радиус АЗС: 500 метров
- Минимальная уверенность для соответствия: 70%

### 5.2. Возможность настройки
Параметры могут быть настроены:
- Глобально для системы
- Для конкретной организации
- Для конкретного провайдера
- Для конкретной АЗС (разные АЗС могут иметь разные радиусы)

## 6. Производительность

### 6.1. Оптимизация запросов
- Индексы на ключевые поля:
  - `vehicle_locations`: (vehicle_id, timestamp)
  - `vehicle_refuels`: (vehicle_id, refuel_date)
  - `fuel_card_analysis_results`: (transaction_id, match_status, is_anomaly)
- Пакетная обработка для массового анализа
- Кэширование результатов анализа

### 6.2. Асинхронная обработка
- Массовый анализ выполняется асинхронно
- Результаты сохраняются в БД
- Уведомления о завершении анализа

## 7. Интеграции

### 7.1. Источники данных о заправках
- GLONASS/GPS системы
- Телематические системы
- Ручной ввод
- API внешних систем

### 7.2. Экспорт результатов
- Экспорт в Excel
- Экспорт в PDF (отчеты)
- API для интеграции с другими системами

## 8. Этапы реализации

### Этап 1: Базовая структура (текущий этап)
- [x] Проектирование
- [ ] Создание моделей данных
- [ ] Миграции БД
- [ ] Базовый сервис анализа

### Этап 2: Основной функционал
- [ ] Алгоритм сопоставления транзакций и заправок
- [ ] Проверка геолокации
- [ ] API эндпоинты
- [ ] Базовые тесты

### Этап 3: Расширенный анализ
- [ ] Выявление аномалий
- [ ] Анализ паттернов
- [ ] Статистика и отчеты
- [ ] Настройки анализа

### Этап 4: Оптимизация и интеграции
- [ ] Оптимизация производительности
- [ ] Асинхронная обработка
- [ ] Интеграции с внешними системами
- [ ] Экспорт данных

## 9. Дополнительные идеи (для будущего развития)

### 9.1. Предиктивная аналитика
- Прогнозирование потребности в топливе
- Выявление карт с высоким риском мошенничества
- Рекомендации по оптимизации маршрутов

### 9.2. Машинное обучение
- Автоматическая классификация аномалий
- Обучение на исторических данных для улучшения точности сопоставления
- Выявление скрытых паттернов

### 9.3. Уведомления и алерты
- Автоматические уведомления об аномалиях
- Настраиваемые правила для различных типов аномалий
- Интеграция с системами уведомлений (email, SMS, Telegram)

### 9.4. Визуализация
- Карта с отображением транзакций и местоположений ТС
- Графики использования карт
- Интерактивные дашборды

### 9.5. Дополнительные проверки
- Проверка рабочего времени водителя (заправка в нерабочее время)
- Проверка маршрута (заправка вне маршрута)
- Проверка частоты заправок (слишком частые заправки)
- Проверка объема заправки (слишком большой/малый объем)

### 9.6. Интеграция с финансовыми системами
- Сопоставление с платежными документами
- Проверка лимитов по картам
- Анализ расходов по картам
