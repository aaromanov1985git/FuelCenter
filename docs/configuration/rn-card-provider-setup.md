# Настройка подключения к API РН-Карт

## Описание

Добавлена поддержка интеграции с WebAPI РН-Карт (версия EMV v2) для получения списка карт и транзакций по договору.

## Тип подключения "api" с provider_type="rncard"

Для подключения к API РН-Карт используется тип подключения `api` с указанием `provider_type: "rncard"` или `"rn-card"`.

## Требования

- Логин и пароль из Личного кабинета РН-Карт
- Код договора
- IP-адрес вашей системы должен быть внесен в белый список в ЛК (раздел 1.4 технического регламента)
- Использование TLS 1.2+ (поддерживается автоматически)

## Настройка шаблона провайдера

### Параметры подключения (connection_settings)

Для типа подключения `api` с `provider_type: "rncard"` необходимо указать следующие параметры в JSON формате:

```json
{
  "provider_type": "rncard",
  "base_url": "https://lkapi.rn-card.ru",
  "login": "ваш_логин",
  "password": "ваш_пароль",
  "contract": "ISS123456",
  "currency": "RUB",
  "use_md5_hash": true
}
```

### Параметры:

- **provider_type** (обязательный) - Тип провайдера: `"rncard"` или `"rn-card"`
- **base_url** (опциональный) - Базовый URL API (по умолчанию `"https://lkapi.rn-card.ru"`)
- **login** (обязательный) - Логин из Личного кабинета РН-Карт (также может быть `username` или `user`)
- **password** (обязательный) - Пароль из Личного кабинета РН-Карт (также может быть `pass`)
- **contract** (обязательный) - Код договора (также может быть `contract_code`)
- **currency** (опциональный) - Валюта по умолчанию (по умолчанию "RUB")
- **use_md5_hash** (опциональный) - Использовать MD5-хеш пароля (рекомендуется, по умолчанию `true`)

### Авторизация

Авторизация осуществляется через HTTP-заголовок `RnCard-Identity-Account-Pass`:
- **Рекомендуемый способ**: `Base64(MD5(пароль))` - используется при `use_md5_hash: true`
- **Альтернативный способ**: `Base64(пароль)` - используется при `use_md5_hash: false`

⚠️ **Важно**: Начиная с версии регламента от 20.12.2023, передача пароля в теле запроса запрещена. Пароль передается только в заголовке.

## Пример использования

### 1. Создание шаблона через API

```bash
POST /api/templates
{
  "provider_id": 1,
  "name": "РН-Карт API",
  "description": "Подключение к API РН-Карт",
  "connection_type": "api",
  "connection_settings": {
    "provider_type": "rncard",
    "base_url": "https://lkapi.rn-card.ru",
    "login": "ваш_логин",
    "password": "ваш_пароль",
    "contract": "ISS123456",
    "use_md5_hash": true
  },
  "field_mapping": {
    "Date": "Дата",
    "Card": "Номер карты",
    "Sum": "Сумма",
    "Value": "Объем",
    "Product": "Вид топлива",
    "AZS": "Номер АЗС",
    "AZSName": "Название АЗС",
    "Address": "Адрес",
    "Region": "Регион",
    "Settlement": "Населенный пункт"
  }
}
```

### 2. Тестирование подключения

```bash
POST /api/templates/test-api-connection?connection_type=api
{
  "provider_type": "rncard",
  "base_url": "https://lkapi.rn-card.ru",
  "login": "ваш_логин",
  "password": "ваш_пароль",
  "contract": "ISS123456"
}
```

### 3. Загрузка транзакций

```bash
POST /api/transactions/load-from-api?template_id=1&date_from=2025-01-01&date_to=2025-01-31
```

Можно указать конкретные карты (опционально):

```bash
POST /api/transactions/load-from-api?template_id=1&date_from=2025-01-01&date_to=2025-01-31&card_numbers=7826010101046205,7826010102761604
```

⚠️ **Ограничение**: Период не может превышать 2 месяца (60 дней). При превышении будет возвращена ошибка.

## Доступные методы API

### 1. Получение списка карт

**Метод**: `GetCardsByContract`  
**Endpoint**: `/api/emv/v1/GetCardsByContract`  
**Параметры**:
- `u` - логин (добавляется автоматически)
- `contract` - код договора (добавляется автоматически)
- `type` - формат ответа (json/xml, по умолчанию json)

**Ответ**:
```json
[
  {
    "Num": "7826010101046205",
    "Rem": "Toyota: 98/100",
    "SName": "В работе",
    "SCode": "00",
    "CardGrp": ""
  },
  {
    "Num": "7826010115121564",
    "Rem": "",
    "SName": "Заблокирована (Клиент)",
    "SCode": "05_C",
    "CardGrp": ""
  },
  ...
]
```

**Поля ответа**:
- `Num` - Номер карты (используется для идентификации)
- `Rem` - Примечание (может содержать информацию о ТС, например "Toyota: 98/100", "МАН: К 146 ОУ 154")
- `SName` - Название статуса карты ("В работе", "Заблокирована (Клиент)" и т.д.)
- `SCode` - Код статуса ("00" - в работе, "05_C" - заблокирована клиентом и т.д.)
- `CardGrp` - Группа карт (может быть пустой)

### 2. Получение транзакций по периоду

**Метод**: `GetOperByContract`  
**Endpoint**: `/api/emv/v2/GetOperByContract`  
**Параметры**:
- `u` - логин
- `contract` - код договора
- `begin` - дата начала (формат ISO 8601: `yyyy-MM-ddTHH:mm:ss`)
- `end` - дата окончания (макс. 2 месяца)
- `type` - формат ответа (json/xml)

**Ответ**:
```json
{
  "OperationList": [
    {
      "Date": "2025-12-10T14:22:15",
      "Card": "7826010101046205",
      "Type": 11,
      "Value": 35.5,
      "Sum": 1420.00,
      "DSum": 0,
      "Price": 40.00,
      "DPrice": 0,
      "Contract": "ISS123456",
      "AZS": "12345",
      "AZSName": "АЗС №1",
      "Product": "Дизельное топливо",
      "Region": "Московская область",
      "Settlement": "Москва",
      "Address": "ул. Примерная, д. 1",
      "PosCoord": "52.261365,104.35507",
      "PosCode": "AZS103884",
      "GCode": "g100",
      "GName": "АИ-100",
      "Vat": 20.0
    },
    ...
  ]
}
```

**Дополнительные поля**:
- `PosCoord` - Координаты АЗС в формате "широта,долгота" (например, "52.261365,104.35507")
- `PosCode` - Код точки продажи
- `GCode` - Код товара
- `GName` - Название товара
- `Vat` - НДС в процентах
- `Type` - Тип операции (11 - заправка, 24 - возврат и т.д.)

### 3. Получение транзакций по дате изменения (для синхронизации)

**Метод**: `GetOperByContractLM`  
**Endpoint**: `/api/emv/v2/GetOperByContractLM`  
**Параметры**:
- `u` - логин
- `contract` - код договора
- `lastHours` - сколько часов назад импортировались или изменялись операции (макс. 120 часов)
- `type` - формат ответа (json/xml)

Этот метод доступен через адаптер, но не используется автоматически. Можно добавить поддержку в будущем.

## Маппинг полей

API РН-Карт возвращает транзакции со следующими полями:

| Поле API | Описание | Маппинг в систему |
|----------|----------|-------------------|
| `Date` | Дата и время транзакции | `transaction_date` |
| `Card` | Номер карты | `card_number` |
| `Value` | Объем топлива | `quantity` |
| `Sum` | Сумма транзакции | `amount` |
| `Price` | Цена за литр | - |
| `Product` | Вид топлива | `product` |
| `AZS` | Номер АЗС | `azs_number` |
| `AZSName` | Название АЗС | `azs_original_name` |
| `Address` | Адрес АЗС | `location` |
| `Region` | Регион | `region` |
| `Settlement` | Населенный пункт | `settlement` |
| `PosCoord` | Координаты АЗС (формат: "широта,долгота") | `azs_latitude`, `azs_longitude` |
| `Contract` | Код договора | - |
| `PosCode` | Код точки продажи | `location_code` |

## Реализованная функциональность

✅ Авторизация через заголовок `RnCard-Identity-Account-Pass` с MD5-хешем  
✅ Получение списка карт через `GetCardsByContract`  
✅ Получение транзакций по периоду через `GetOperByContract`  
✅ Автоматическая фильтрация транзакций по указанным картам  
✅ Автоматическое заполнение координат АЗС из поля `PosCoord`  
✅ Проверка подключения (healthcheck)  
✅ Поддержка автоматической загрузки  
✅ Интеграция с системой шаблонов  
✅ Обработка ошибок и логирование  
✅ Поддержка RequestId для диагностики  

## Архитектура

- **RnCardAdapter** - адаптер для работы с API РН-Карт
- **ApiProviderService** - расширен для поддержки типа "rncard"
- **AutoLoadService** - поддерживает автоматическую загрузку для типа "rncard"

## Безопасность

- Пароль передается только в HTTP-заголовке (не в URL и не в теле запроса)
- Рекомендуется использовать MD5-хеш пароля (`use_md5_hash: true`)
- Используется TLS 1.2+ для всех запросов
- Добавлен RequestId (GUID) в заголовках для диагностики

## Обработка ошибок

Адаптер обрабатывает следующие ошибки:

- **HTTP 404** - Неправильный URL или IP не в белом списке
- **HTTP 403** - Неправильные учетные данные или IP заблокирован
- **Период > 2 месяцев** - Ошибка валидации периода
- **Таймаут** - Ошибка подключения к серверу

Все ошибки логируются с подробной информацией для диагностики.

## Дополнительные рекомендации

1. **Создайте отдельную учетную запись** в ЛК РН-Карт специально для интеграции
2. **Ограничьте IP-адреса** в белом списке ЛК для повышения безопасности
3. **Не делайте частые запросы** - возможна блокировка за DDoS-поведение (см. п. 1.5 регламента)
4. **Используйте автоматическую загрузку** для регулярного получения данных
5. **Мониторьте логи** для выявления проблем с подключением

## Примеры использования в коде

### Python (для справки)

```python
from app.services.api_provider_service import RnCardAdapter
from datetime import date, timedelta

# Создание адаптера
adapter = RnCardAdapter(
    base_url="https://lkapi.rn-card.ru",
    login="ваш_логин",
    password="ваш_пароль",
    contract="ISS123456",
    use_md5_hash=True
)

# Использование
async with adapter:
    # Получение списка карт
    cards = await adapter.list_cards()
    
    # Получение транзакций за период
    date_from = date.today() - timedelta(days=30)
    date_to = date.today()
    transactions = await adapter.fetch_card_transactions("", date_from, date_to)
    
    # Проверка подключения
    health = await adapter.healthcheck()
```

## Дальнейшее развитие

Возможные улучшения:

1. Добавить поддержку метода `GetOperByContractLM` для синхронизации по дате изменения
2. Добавить кэширование списка карт
3. Добавить поддержку пагинации для больших объемов данных
4. Добавить метрики и мониторинг производительности
