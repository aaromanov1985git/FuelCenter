// Полный код формы для работы с PPR API v1
// Адаптирован для использования POST-запросов с JSON в теле

// ============================================================================
// Глобальные переменные формы
// ============================================================================

Токен = "yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR";

// ============================================================================
// Процедуры и функции для работы с API
// ============================================================================

// Получить транзакции за период через PPR API v1
//
// Использует глобальные переменные формы:
//   URL - Адрес сервера (например, "malignantly-meteoric-stallion.cloudpub.ru")
//   Токен - API ключ для авторизации
//   ДатаНачала - Начальная дата периода (включительно)
//   ДатаОкончания - Конечная дата периода (включительно)
//   Транзакции - ТаблицаЗначений для заполнения транзакциями
//
Процедура ПолучениеТранзакцийЗаПериодППР()
	
	dateFrom = Формат(ДатаНачала, "ДФ=yyyy-MM-dd");
	dateTo = Формат(ДатаОкончания, "ДФ=yyyy-MM-dd");
	
	URL = "malignantly-meteoric-stallion.cloudpub.ru";
	
	// API v1 использует POST-запрос с JSON в теле
	Ресурс = "/public-api/v1/transaction-list";
	Метод = "ТранзакцийЗаПериодППР";
	
	// Формируем тело запроса в формате JSON
	ТелоЗапроса = Новый Структура;
	ТелоЗапроса.Вставить("token", Токен);
	ТелоЗапроса.Вставить("dateFrom", dateFrom);
	ТелоЗапроса.Вставить("dateTo", dateTo);
	ТелоЗапроса.Вставить("format", "JSON");
	
	// Преобразуем структуру в JSON строку
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ТелоЗапроса);
	ТелоJSON = ЗаписьJSON.Закрыть();
	
	СоотвИзJSON = ВыполнитьHTTPЗапросППР_POST(URL, Ресурс, ТелоJSON, Метод);
	
	Если НЕ СоотвИзJSON = Неопределено Тогда
		// В API v1 ответ содержит поле "array-list" вместо "transactions"
		Если СоотвИзJSON.Свойство("array-list") Тогда
			МассивТранзакций = СоотвИзJSON["array-list"];
			Если МассивТранзакций.Количество() > 0 Тогда
				Для каждого ЭлТранзакции из МассивТранзакций Цикл
					НовТранзакция = Транзакции.Добавить();
					ЗаполнитьЗначенияСвойств(НовТранзакция, ЭлТранзакции);
					НовТранзакция.Дата = ПрочитатьДатуJSON(ЭлТранзакции.date, ФорматДатыJSON.ISO);
					НовТранзакция.cardNum = Формат(ЭлТранзакции.cardNum, "ЧГ=");
					Если ЭлТранзакции.TypeID = 1 Тогда
						НовТранзакция.TypeID = "Заправка";
					Иначе
						НовТранзакция.TypeID = "Возврат";
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		Иначе
			Сообщить("Ошибка: В ответе отсутствует поле 'array-list'");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Выполнить HTTP POST-запрос к PPR API v1
//
// Параметры:
//   URL - Строка - Адрес сервера без протокола
//   Ресурс - Строка - Путь к ресурсу
//   ТелоJSON - Строка - JSON строка для тела запроса
//   Метод - Строка - Название метода для логирования ошибок
//
// Возвращаемое значение:
//   Соответствие - Результат парсинга JSON ответа, или Неопределено в случае ошибки
//
Функция ВыполнитьHTTPЗапросППР_POST(URL, Ресурс, ТелоJSON, Метод)
	
	Попытка
		// Используем HTTPS для безопасного соединения
		ssl = Новый ЗащищенноеСоединениеOpenSSL();
		
		// Формируем заголовки запроса
		ЗаголовокЗапросаHTTP = Новый Соответствие;
		ЗаголовокЗапросаHTTP.Вставить("Content-Type", "application/json");
		ЗаголовокЗапросаHTTP.Вставить("Accept", "application/json");
		
		// Создаем HTTP-соединение (HTTPS, так как используем SSL)
		Соединение = Новый HTTPСоединение(URL, , , , , , ssl);
		
		// Создаем HTTP-запрос с методом POST
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс, ЗаголовокЗапросаHTTP);
		HTTPЗапрос.Метод = "POST";
		
		// Устанавливаем тело запроса
		HTTPЗапрос.УстановитьТелоИзСтроки(ТелоJSON);
		
		// Выполняем запрос
		Ответ = Соединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
		
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (Соединение.ВызватьHTTPМетод) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	// Проверяем код состояния ответа
	Если Ответ.КодСостояния <> 200 Тогда
		Сообщить("Ошибка работы " + Метод + " Ответ.КодСостояния <> 200 " + Ресурс + " " + Ответ.ПолучитьТелоКакСтроку());
		Возврат Неопределено;
	КонецЕсли;
	
	// Получаем тело ответа
	ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
	
	Попытка
		// Парсим JSON ответ
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		СоотвИзJSON = ПрочитатьJSON(ЧтениеJSON);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (ПрочитатьJSON) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат СоотвИзJSON;
	
КонецФункции

// ============================================================================
// Обработчики событий формы
// ============================================================================

// Обработчик нажатия кнопки "Выполнить"
Процедура КнопкаВыполнитьНажатие(Кнопка)
	// Вставить содержимое обработчика.
КонецПроцедуры

// Обработчик действия "Загрузить транзакции"
Процедура КоманднаяПанель1Действие9(Кнопка)
	
	Если Не ПроверитьЗаполнение() Тогда
		Сообщить("Необходимо заполнить обязательные поля!");
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ДатаНачала) И ЗначениеЗаполнено(ДатаОкончания) И ЗначениеЗаполнено(Токен) Тогда
		ПолучениеТранзакцийЗаПериодППР();
	Иначе
		Сообщить("Необходимо заполнить обязательные поля!");
	КонецЕсли;
	
	// Обработка загруженных транзакций
	Для Каждого Строка1 Из ЭтотОбъект.Транзакции Цикл
		// Обработка номера карты
		Строка1.cardNum = СтрЗаменить(Строка1.cardNum, "300", "");
		
		// Поиск пластиковой карты
		Если Справочники.уатПластиковыеКарты.НайтиПоКоду(Строка1.cardNum) <> Справочники.уатПластиковыеКарты.ПустаяСсылка() Тогда
			Строка1.ПластиковаяКарта = Справочники.уатПластиковыеКарты.НайтиПоКоду(Строка1.cardNum);
			Строка1.КомуВыдана = Строка1.ПластиковаяКарта.КомуВыдана;
		Иначе
			Строка1.ПластиковаяКарта = Справочники.уатПластиковыеКарты.НайтиПоКоду(Строка1.cardNum + "деж");
			Строка1.КомуВыдана = Строка1.ПластиковаяКарта.КомуВыдана;
		КонецЕсли;
		
		// Обработка государственного номера ТС
		Строка1.carNumber = СтрЗаменить(Строка1.carNumber, " ", "");
		Строка1.ТС = ТСпоГаражному(Строка1.carNumber, Организация, Строка1.Дата);
		
		// Проверка на возврат
		Если Строка1.TypeID = "Возврат" Тогда
			ЭлементыФормы.КоманднаяПанель1.Кнопки.Действие10.Доступность = Истина;
		КонецЕсли;
	КонецЦикла;
	
	ЭлементыФормы.КоманднаяПанель1.Кнопки.Действие11.Доступность = Истина;
	
КонецПроцедуры

// Обработчик действия "Свернуть транзакции"
Процедура КоманднаяПанель1Действие10(Кнопка)
	ЭтотОбъект.Транзакции.Свернуть("Дата,cardNum,carNumber,serviceName,posAddress,ПластиковаяКарта,КомуВыдана,ТС,price", "amount,sum");
КонецПроцедуры

// Обработчик действия "Перенести в документ"
Процедура КоманднаяПанель1Действие11(Кнопка)
	
	Если Не ПроверитьЗаполнение() Тогда
		Возврат;
	КонецЕсли;
	
	ОбъектЗаправкаОбщая = ЭтотОбъект.ЗОДок.ПолучитьОбъект();
	
	Если ОбъектЗаправкаОбщая.Заправки.Количество() > 0 Тогда
		Ответ = Вопрос("Перед заполнением таблица документа будет очищена. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ОбъектЗаправкаОбщая.Заправки.Очистить();
		КонецЕсли;
	КонецЕсли;
	
	// Перенос транзакций в документ
	Для Каждого Строка1 Из ЭтотОбъект.Транзакции Цикл
		НовТранзакция = ОбъектЗаправкаОбщая.Заправки.Добавить();
		НовТранзакция.Дата = Строка1.Дата;
		
		// Определение вида ГСМ по serviceName
		Если Строка1.serviceName = "АИ-92" Тогда
			НовТранзакция.ГСМ = Справочники.Номенклатура.НайтиПоКоду("00000000182");
		ИначеЕсли Строка1.serviceName = "АИ-95" Тогда
			НовТранзакция.ГСМ = Справочники.Номенклатура.НайтиПоКоду("00000000179");
		ИначеЕсли Строка1.serviceName = "ДТ" Тогда
			НовТранзакция.ГСМ = Справочники.Номенклатура.НайтиПоКоду("00000000178");
		КонецЕсли;
		
		// В API v1 amount = количество (литры), sum = сумма
		НовТранзакция.Количество = Строка1.amount;
		// НовТранзакция.Сумма = Строка1.sum;  // Раскомментировать, если нужно
		НовТранзакция.ПластиковаяКарта = Строка1.ПластиковаяКарта;
		НовТранзакция.ТС = Строка1.ТС;
	КонецЦикла;
	
	Попытка
		ОбъектЗаправкаОбщая.Записать(РежимЗаписиДокумента.Запись);
	Исключение
		Сообщить("Ошибка переноса!");
	КонецПопытки;
	
КонецПроцедуры

// ============================================================================
// Вспомогательные функции
// ============================================================================

// Получить ТС по государственному номеру
//
// Параметры:
//   ГосударственныйНомер - Строка - Государственный номер ТС
//   Организация - СправочникСсылка - Организация
//   Дата - Дата - Дата для среза регистра
//
// Возвращаемое значение:
//   СправочникСсылка - Ссылка на основное средство (ТС)
//
Функция ТСпоГаражному(ГосударственныйНомер, Организация, Дата)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	уатПервоначальныеСведенияТС.ОсновноеСредство
		|ИЗ
		|	РегистрСведений.уатПервоначальныеСведенияТС КАК уатПервоначальныеСведенияТС
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.уатМестонахождениеТС.СрезПоследних(&Период, ) КАК уатМестонахождениеТССрезПоследних
		|		ПО уатПервоначальныеСведенияТС.ОсновноеСредство = уатМестонахождениеТССрезПоследних.ТС
		|ГДЕ
		|	уатПервоначальныеСведенияТС.ДатаВыбытия = ДАТАВРЕМЯ(1, 1, 1)
		|	И уатМестонахождениеТССрезПоследних.Организация = &Организация
		|	И уатПервоначальныеСведенияТС.ГосударственныйНомер = &ГосударственныйНомер";
	
	Запрос.УстановитьПараметр("ГосударственныйНомер", ГосударственныйНомер);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Период", Дата);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Количество() = 0 Тогда
		Возврат Справочники.ОсновныеСредства.ПустаяСсылка();
	КонецЕсли;
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ОсновноеСредство;
	КонецЕсли;
	
КонецФункции

// ============================================================================
// Обработчики событий элементов формы
// ============================================================================

// Обработчик получения данных табличного поля
Процедура ТабличноеПоле1ПриПолученииДанных(Элемент, ОформленияСтрок)
	
	Для каждого ТекСтрока Из ОформленияСтрок Цикл
		// Подсветка строк, где ТС не совпадает с "КомуВыдана"
		Если ТекСтрока.ДанныеСтроки.ТС <> ТекСтрока.ДанныеСтроки.КомуВыдана Тогда
			ТекСтрока.ЦветФона = Новый Цвет(255, 0, 0);
		КонецЕсли;
		
		// Подсветка строк с возвратом
		Если ТекСтрока.ДанныеСтроки.TypeID = "Возврат" Тогда
			ТекСтрока.ЦветФона = Новый Цвет(255, 255, 0);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Обработчик изменения поля ввода АЗС
Процедура ПолеВвода4ПриИзменении(Элемент)
	
	Если ЭтотОбъект.ЗОДок.АЗС <> Справочники.уатАЗС.НайтиПоНаименованию("ППР") Тогда
		ЗОДок = Документы.уатЗаправкаГСМОбщая.ПустаяСсылка();
		Сообщить("В документе Заправка Общая(уат) указана не верная АЗС. Данная загрузка подходит только для ППР!");
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

