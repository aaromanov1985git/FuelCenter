# Интеграция с 1С ERP (Рарус Модуль автотранспорта для ЕРП)

## Обзор

Система GSM Converter интегрируется с модулем 1С "Рарус Модуль автотранспорта для ЕРП" через REST API. Интеграция позволяет загружать данные о транзакциях ГСМ из системы GSM Converter в документ "Отчет поставщика ПЦ" в 1С.

## Архитектура интеграции

```
┌─────────────────────┐         ┌──────────────────────┐
│   GSM Converter     │         │   1С ERP (Рарус)     │
│   (FastAPI)         │◄────────┤  уатЗагрузкаПЦ       │
│                     │  REST   │                      │
│  /api/v1/onec/     │  API    │  СоздатьЗаправкиВ    │
│  transactions       │         │  ОтчетеПЦ            │
└─────────────────────┘         └──────────────────────┘
```

## API Endpoint

### Получение транзакций для 1С

**URL:** `GET /api/v1/onec/transactions`

**Параметры запроса:**
- `provider_id` (обязательный) - ID провайдера для фильтрации транзакций
- `date_from` (необязательный) - Начальная дата периода в формате `YYYY-MM-DD` или `YYYY-MM-DD HH:MM:SS`
- `date_to` (необязательный) - Конечная дата периода в формате `YYYY-MM-DD` или `YYYY-MM-DD HH:MM:SS`
- `skip` (необязательный, по умолчанию 0) - Количество записей для пропуска (пагинация)
- `limit` (необязательный, по умолчанию 1000) - Максимальное количество записей на странице (максимум 1000)

**Пример запроса:**
```
GET /api/v1/onec/transactions?provider_id=1&date_from=2025-01-01&date_to=2025-01-31&skip=0&limit=1000
```

**Формат ответа:**
```json
{
  "Успех": true,
  "Транзакции": [
    {
      "Дата": "2025-01-15T10:30:00",
      "Количество": 50.5,
      "МестоЗаправкиКод": "12345",
      "МестоЗаправкиНаименование": "АЗС №1, г. Москва",
      "НоменклатураОтчета": "Дизельное топливо",
      "ПластиковаяКартаОтчета": "1234567890123456",
      "ТСОтчета": "А123БВ 777",
      "Сумма": 2500.00,
      "СтавкаНДС": 20.0,
      "СуммаНДС": 416.67,
      "Лат": null,
      "Лон": null,
      "Транзакция": "123_20250115103000"
    }
  ],
  "ВсегоЗаписей": 150,
  "СообщениеОбОшибке": ""
}
```

## Использование в модуле 1С

### Функция `ПолучитьТранзакцииДляЗагрузкиПЦ`

Модуль 1С содержит функцию для получения данных в формате, ожидаемом процедурой `СоздатьЗаправкиВОтчетеПЦ`.

**Сигнатура функции:**
```bsl
Функция ПолучитьТранзакцииДляЗагрузкиПЦ(
    АдресСервера, 
    ИДПровайдера, 
    ДатаНачала = Неопределено, 
    ДатаОкончания = Неопределено, 
    Пропустить = 0, 
    Лимит = 1000) Экспорт
```

**Параметры:**
- `АдресСервера` - Адрес API сервера (например, "http://localhost:8000")
- `ИДПровайдера` - ID провайдера для фильтрации транзакций
- `ДатаНачала` - Начальная дата периода (включительно), необязательный
- `ДатаОкончания` - Конечная дата периода (включительно), необязательный
- `Пропустить` - Количество записей для пропуска (для пагинации), по умолчанию 0
- `Лимит` - Максимальное количество записей на странице, по умолчанию 1000

**Возвращаемое значение:**
Структура с полями:
- `Успех` - Булево - Признак успешного выполнения запроса
- `Транзакции` - Массив - Массив структур с данными транзакций в формате для уатЗагрузкаПЦ
- `ВсегоЗаписей` - Число - Общее количество записей, соответствующих фильтрам
- `СообщениеОбОшибке` - Строка - Текст ошибки (заполняется при Успех = Ложь)

**Формат структуры транзакции:**
- `Дата` - Дата транзакции
- `Количество` - Количество топлива
- `МестоЗаправкиКод` - Код АЗС
- `МестоЗаправкиНаименование` - Наименование АЗС
- `НоменклатураОтчета` - Наименование товара
- `ПластиковаяКартаОтчета` - Номер карты
- `ТСОтчета` - Транспортное средство
- `Сумма` - Сумма транзакции
- `СтавкаНДС` - Ставка НДС (может быть Неопределено)
- `СуммаНДС` - Сумма НДС
- `Лат` - Широта (может быть Неопределено)
- `Лон` - Долгота (может быть Неопределено)
- `Транзакция` - Уникальный идентификатор транзакции

### Пример использования в 1С

```bsl
// Получаем структуру параметров для работы с ПЦ
СтруктураПараметровУчетнойЗаписи = уатЗагрузкаПЦ.ПолучитьСтруктуруПараметровДляРаботыСПЦ(УчетнаяЗаписьСистемыПЦ);

// Получаем транзакции из GSM Converter
АдресСервера = "http://localhost:8000";
ИДПровайдера = 1; // ID провайдера в системе GSM Converter
ДатаНачала = Дата(2025, 1, 1);
ДатаОкончания = Дата(2025, 1, 31);

Результат = 1C_API_Integration.ПолучитьТранзакцииДляЗагрузкиПЦ(
    АдресСервера, 
    ИДПровайдера, 
    ДатаНачала, 
    ДатаОкончания
);

Если Результат.Успех Тогда
    
    // Преобразуем данные в формат для уатЗагрузкаПЦ
    мсвЗагруженныеДанные = Новый Массив();
    
    Для Каждого Транзакция Из Результат.Транзакции Цикл
        
        // Создаем структуру в формате, ожидаемом СоздатьЗаправкиВОтчетеПЦ
        СтруктураЗаправки = Новый Структура;
        СтруктураЗаправки.Вставить("Дата", Транзакция.Дата);
        СтруктураЗаправки.Вставить("Количество", Транзакция.Количество);
        СтруктураЗаправки.Вставить("МестоЗаправкиКод", Транзакция.МестоЗаправкиКод);
        СтруктураЗаправки.Вставить("МестоЗаправкиНаименование", Транзакция.МестоЗаправкиНаименование);
        СтруктураЗаправки.Вставить("НоменклатураОтчета", Транзакция.НоменклатураОтчета);
        СтруктураЗаправки.Вставить("ПластиковаяКартаОтчета", Транзакция.ПластиковаяКартаОтчета);
        СтруктураЗаправки.Вставить("ТСОтчета", Транзакция.ТСОтчета);
        СтруктураЗаправки.Вставить("Сумма", Транзакция.Сумма);
        СтруктураЗаправки.Вставить("СтавкаНДС", Транзакция.СтавкаНДС);
        СтруктураЗаправки.Вставить("СуммаНДС", Транзакция.СуммаНДС);
        СтруктураЗаправки.Вставить("Лат", Транзакция.Лат);
        СтруктураЗаправки.Вставить("Лон", Транзакция.Лон);
        СтруктураЗаправки.Вставить("Транзакция", Транзакция.Транзакция);
        
        мсвЗагруженныеДанные.Добавить(СтруктураЗаправки);
        
    КонецЦикла;
    
    // Создаем заправки в документе "Отчет поставщика ПЦ"
    уатЗагрузкаПЦ.СоздатьЗаправкиВОтчетеПЦ(
        СтруктураПараметровУчетнойЗаписи, 
        мсвЗагруженныеДанные,
        ДатаНачала,
        ТекущаяДата()
    );
    
Иначе
    
    Сообщить("Ошибка при получении данных: " + Результат.СообщениеОбОшибке);
    
КонецЕсли;
```

### Пример с пагинацией

```bsl
АдресСервера = "http://localhost:8000";
ИДПровайдера = 1;
ДатаНачала = Дата(2025, 1, 1);
ДатаОкончания = Дата(2025, 1, 31);
ЛимитНаСтранице = 100;
Пропустить = 0;

мсвВсеЗагруженныеДанные = Новый Массив();

Пока Истина Цикл
    
    Результат = 1C_API_Integration.ПолучитьТранзакцииДляЗагрузкиПЦ(
        АдресСервера, 
        ИДПровайдера, 
        ДатаНачала, 
        ДатаОкончания,
        Пропустить,
        ЛимитНаСтранице
    );
    
    Если Не Результат.Успех Тогда
        
        Сообщить("Ошибка: " + Результат.СообщениеОбОшибке);
        Прервать;
        
    КонецЕсли;
    
    Если Результат.Транзакции.Количество() = 0 Тогда
        
        Прервать;
        
    КонецЕсли;
    
    // Преобразуем транзакции в формат для уатЗагрузкаПЦ
    Для Каждого Транзакция Из Результат.Транзакции Цикл
        
        СтруктураЗаправки = Новый Структура;
        СтруктураЗаправки.Вставить("Дата", Транзакция.Дата);
        СтруктураЗаправки.Вставить("Количество", Транзакция.Количество);
        СтруктураЗаправки.Вставить("МестоЗаправкиКод", Транзакция.МестоЗаправкиКод);
        СтруктураЗаправки.Вставить("МестоЗаправкиНаименование", Транзакция.МестоЗаправкиНаименование);
        СтруктураЗаправки.Вставить("НоменклатураОтчета", Транзакция.НоменклатураОтчета);
        СтруктураЗаправки.Вставить("ПластиковаяКартаОтчета", Транзакция.ПластиковаяКартаОтчета);
        СтруктураЗаправки.Вставить("ТСОтчета", Транзакция.ТСОтчета);
        СтруктураЗаправки.Вставить("Сумма", Транзакция.Сумма);
        СтруктураЗаправки.Вставить("СтавкаНДС", Транзакция.СтавкаНДС);
        СтруктураЗаправки.Вставить("СуммаНДС", Транзакция.СуммаНДС);
        СтруктураЗаправки.Вставить("Лат", Транзакция.Лат);
        СтруктураЗаправки.Вставить("Лон", Транзакция.Лон);
        СтруктураЗаправки.Вставить("Транзакция", Транзакция.Транзакция);
        
        мсвВсеЗагруженныеДанные.Добавить(СтруктураЗаправки);
        
    КонецЦикла;
    
    // Переходим на следующую страницу
    Пропустить = Пропустить + ЛимитНаСтранице;
    
    Если Пропустить >= Результат.ВсегоЗаписей Тогда
        
        Прервать;
        
    КонецЕсли;
    
КонецЦикла;

// Создаем заправки в документе "Отчет поставщика ПЦ"
СтруктураПараметровУчетнойЗаписи = уатЗагрузкаПЦ.ПолучитьСтруктуруПараметровДляРаботыСПЦ(УчетнаяЗаписьСистемыПЦ);

уатЗагрузкаПЦ.СоздатьЗаправкиВОтчетеПЦ(
    СтруктураПараметровУчетнойЗаписи, 
    мсвВсеЗагруженныеДанные,
    ДатаНачала,
    ТекущаяДата()
);
```

## Маппинг полей

| Поле в GSM Converter | Поле в 1С (уатЗагрузкаПЦ) | Описание |
|---------------------|--------------------------|----------|
| `transaction_date` | `Дата` | Дата и время транзакции |
| `quantity` | `Количество` | Количество топлива |
| `location_code` или `azs_number` | `МестоЗаправкиКод` | Код АЗС |
| `gas_station.name` или `location` или `azs_number` | `МестоЗаправкиНаименование` | Наименование АЗС |
| `product` | `НоменклатураОтчета` | Наименование товара |
| `card_number` | `ПластиковаяКартаОтчета` | Номер карты |
| `vehicle` | `ТСОтчета` | Транспортное средство |
| `amount_with_discount` или `amount` | `Сумма` | Сумма транзакции |
| `vat_rate` | `СтавкаНДС` | Ставка НДС |
| `vat_amount` | `СуммаНДС` | Сумма НДС |
| - | `Лат` | Широта (пока не используется) |
| - | `Лон` | Долгота (пока не используется) |
| `id` + `transaction_date` | `Транзакция` | Уникальный идентификатор транзакции |

## Настройка

### 1. Настройка адреса API сервера

В модуле 1С укажите адрес вашего API сервера:
```bsl
АдресСервера = "http://localhost:8000"; // или ваш адрес сервера
```

### 2. Определение ID провайдера

ID провайдера можно получить через API:
```
GET /api/v1/providers
```

Или посмотреть в интерфейсе системы GSM Converter.

### 3. Аутентификация

Если в системе включена аутентификация (`ENABLE_AUTH=true`), необходимо передавать токен авторизации в заголовке запроса. Для этого нужно обновить функцию `ПолучитьТранзакцииДляЗагрузкиПЦ` в модуле 1С:

```bsl
// Добавить после создания Запрос
Запрос.Заголовки.Вставить("Authorization", "Bearer " + ТокенАвторизации);
```

## Обработка ошибок

Функция `ПолучитьТранзакцииДляЗагрузкиПЦ` обрабатывает все исключения и возвращает структуру с полем `Успех = Ложь` и описанием ошибки в поле `СообщениеОбОшибке`.

Пример обработки ошибок:
```bsl
Результат = 1C_API_Integration.ПолучитьТранзакцииДляЗагрузкиПЦ(...);

Если Не Результат.Успех Тогда
    
    Сообщить("Ошибка: " + Результат.СообщениеОбОшибке);
    // Дополнительная обработка ошибки
    
КонецЕсли;
```

## Ограничения

1. Максимальное количество записей на странице: 1000
2. Для получения больших объемов данных используйте пагинацию
3. Поля `Лат` и `Лон` пока не заполняются (зарезервированы для будущего использования)

## Поддержка

При возникновении проблем с интеграцией:
1. Проверьте логи API сервера
2. Убедитесь, что адрес сервера указан правильно
3. Проверьте, что провайдер с указанным ID существует
4. Убедитесь, что период дат указан корректно

## Версия

- API версия: 1.0
- Совместимость с 1С: 8.3.23 и выше
- Дата создания: 2025-01-27

