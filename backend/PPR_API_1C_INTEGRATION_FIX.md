# Исправление интеграции с модулем 1С для PPR API

## Проблема в коде модуля 1С

В функции `ВыполнитьHTTPЗапросППР` используется неправильный способ создания HTTP соединения:

```bsl
// НЕПРАВИЛЬНО:
URL = "http://10.35.1.200:8000";
Соединение = Новый HTTPСоединение(URL,,,,,,ssl);
```

`HTTPСоединение` не принимает полный URL как первый параметр. Нужно передавать хост и порт отдельно.

## Правильное решение

### Полный код исправленной функции

```bsl
Функция ВыполнитьHTTPЗапросППР(URL, Ресурс, Токен, Метод)  

	Попытка
		ЗаголовокЗапросаHTTP = Новый Соответствие();  
		ЗаголовокЗапросаHTTP.Вставить("Content-Type", "application/json");
		ЗаголовокЗапросаHTTP.Вставить("Authorization", Токен); 
		
		// ИСПРАВЛЕНИЕ: Извлекаем хост и порт из URL
		// URL может быть в формате "http://10.35.1.200:8000" или "https://10.35.1.200:8000"
		Хост = "";
		Порт = 80;
		ИспользоватьSSL = Ложь;
		
		ЧастиURL = СтрРазделить(URL, "://");
		Если ЧастиURL.Количество() = 2 Тогда
			// Определяем протокол
			Протокол = ЧастиURL[0]; // "http" или "https"
			ИспользоватьSSL = (Протокол = "https");
			
			// Получили протокол и хост:порт
			ХостИПорт = ЧастиURL[1]; // "10.35.1.200:8000"
			ЧастиХостПорт = СтрРазделить(ХостИПорт, ":");
			Если ЧастиХостПорт.Количество() = 2 Тогда
				Хост = ЧастиХостПорт[0]; // "10.35.1.200"
				Порт = Число(ЧастиХостПорт[1]); // 8000
			Иначе
				// Если порт не указан, используем хост как есть и порт по умолчанию
				Хост = ХостИПорт;
				Если ИспользоватьSSL Тогда
					Порт = 443;
				Иначе
					Порт = 80;
				КонецЕсли;
			КонецЕсли;
		Иначе
			// Если URL не содержит "://", считаем что это уже хост
			Хост = URL;
			Порт = 8000; // Порт по умолчанию для нашего API
			ИспользоватьSSL = Ложь;
		КонецЕсли;
		
		// Создаем HTTP соединение с правильными параметрами
		// Для HTTP не используем SSL, для HTTPS - используем
		Если ИспользоватьSSL Тогда
			ssl = Новый ЗащищенноеСоединениеOpenSSL();
			Соединение = Новый HTTPСоединение(Хост, Порт,,,,,ssl);
		Иначе
			// Для HTTP соединения SSL не нужен
			Соединение = Новый HTTPСоединение(Хост, Порт);
		КонецЕсли;
		
		// Создаем HTTP запрос с ресурсом и заголовками
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс, ЗаголовокЗапросаHTTP);
		
		// Выполняем GET запрос
		Ответ = Соединение.Получить(HTTPЗапрос);
		
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (Соединение.Получить) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

	// Проверяем код состояния ответа
	Если Ответ.КодСостояния <> 200 Тогда
		Сообщить("Ошибка работы " + Метод + " Ответ.КодСостояния <> 200 " + Ресурс + " " + Ответ.ПолучитьТелоКакСтроку());
		Возврат Неопределено;
	Конецесли;

	// Получаем тело ответа
	ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
	
	Попытка
		// Парсим JSON ответ
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		СоотвИзJSON = ПрочитатьJSON(ЧтениеJSON);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (ПрочитатьJSON) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

	Возврат СоотвИзJSON;

КонецФункции
```

### Вариант 1: Использование HTTPСоединение правильно (упрощенный)

```bsl
Функция ВыполнитьHTTPЗапросППР(URL, Ресурс, Токен, Метод)  

	Попытка
		ssl = Новый ЗащищенноеСоединениеOpenSSL(); 
		ЗаголовокЗапросаHTTP = Новый Соответствие();  
		ЗаголовокЗапросаHTTP.Вставить("Content-Type", "application/json");
		ЗаголовокЗапросаHTTP.Вставить("Authorization", Токен); 
		
		// ПРАВИЛЬНО: Извлекаем хост и порт из URL
		// URL = "http://10.35.1.200:8000"
		// Нужно получить хост = "10.35.1.200" и порт = 8000
		
		// Простой способ: если URL всегда в формате "http://IP:PORT"
		ЧастиURL = СтрРазделить(URL, "://");
		Если ЧастиURL.Количество() = 2 Тогда
			ХостИПорт = ЧастиURL[1]; // "10.35.1.200:8000"
			ЧастиХостПорт = СтрРазделить(ХостИПорт, ":");
			Если ЧастиХостПорт.Количество() = 2 Тогда
				Хост = ЧастиХостПорт[0]; // "10.35.1.200"
				Порт = Число(ЧастиХостПорт[1]); // 8000
			Иначе
				Хост = ХостИПорт;
				Порт = 80; // По умолчанию
			КонецЕсли;
		Иначе
			Хост = "10.35.1.200";
			Порт = 8000;
		КонецЕсли;
		
		Соединение = Новый HTTPСоединение(Хост, Порт,,,,,ssl);
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс, ЗаголовокЗапросаHTTP);
		Ответ = Соединение.Получить(HTTPЗапрос);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (Соединение.Получить) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

	Если Ответ.КодСостояния <> 200 Тогда
		Сообщить("Ошибка работы " + Метод + " Ответ.КодСостояния <> 200 " + Ресурс + " " + Ответ.ПолучитьТелоКакСтроку());
		Возврат Неопределено;
	Конецесли;

	ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		СоотвИзJSON = ПрочитатьJSON(ЧтениеJSON);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (ПрочитатьJSON) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

	Возврат СоотвИзJSON;

КонецФункции
```

### Вариант 2: Упрощенный вариант (если URL всегда известен)

```bsl
Функция ВыполнитьHTTPЗапросППР(URL, Ресурс, Токен, Метод)  

	Попытка
		ssl = Новый ЗащищенноеСоединениеOpenSSL(); 
		ЗаголовокЗапросаHTTP = Новый Соответствие();  
		ЗаголовокЗапросаHTTP.Вставить("Content-Type", "application/json");
		ЗаголовокЗапросаHTTP.Вставить("Authorization", Токен); 
		
		// Прямое указание хоста и порта
		// ВАЖНО: Для HTTPS используйте порт 443
		Хост = "10.35.1.200";
		Если ИспользоватьSSL Тогда
			Порт = 443;
		Иначе
			Порт = 8000;
		КонецЕсли;
		
		Соединение = Новый HTTPСоединение(Хост, Порт,,,,,ssl);
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс, ЗаголовокЗапросаHTTP);
		Ответ = Соединение.Получить(HTTPЗапрос);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (Соединение.Получить) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

	Если Ответ.КодСостояния <> 200 Тогда
		Сообщить("Ошибка работы " + Метод + " Ответ.КодСостояния <> 200 " + Ресурс + " " + Ответ.ПолучитьТелоКакСтроку());
		Возврат Неопределено;
	Конецесли;

	ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		СоотвИзJSON = ПрочитатьJSON(ЧтениеJSON);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (ПрочитатьJSON) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

	Возврат СоотвИзJSON;

КонецФункции
```

## Формат ответа API

API возвращает транзакции в поле `transactions` с следующими полями:

```json
{
  "success": true,
  "transactions": [
    {
      "date": "2025-12-01T10:30:00",
      "cardNum": "1234567890123456",
      "TypeID": 1
    },
    {
      "date": "2025-12-02T14:20:00",
      "cardNum": "1234567890123457",
      "TypeID": 1
    }
  ],
  "total": 100
}
```

### Поля транзакции:

- `date` (string) - Дата и время транзакции в формате ISO 8601 (например, "2025-12-01T10:30:00")
- `cardNum` (string) - Номер карты
- `TypeID` (integer) - Тип операции:
  - `1` = "Заправка"
  - `0` = "Возврат"

## Проверка работы

После исправления кода модуль должен:

1. Успешно подключаться к серверу
2. Получать ответ со статусом 200
3. Парсить JSON ответ
4. Обрабатывать массив `transactions`
5. Извлекать поля `date`, `cardNum`, `TypeID` из каждой транзакции

## Тестирование

Проверьте работу через PowerShell:

```powershell
$apiKey = "yzsdzCsjyJpHOHwSwnynQzsGVDEZeXcR"
$headers = @{
    Authorization = $apiKey
    Content-Type = "application/json"
}

$url = "http://10.35.1.200:8000/api/public-api/v2/transactions?dateFrom=2025-12-01&dateTo=2025-12-20&format=json"
$response = Invoke-RestMethod -Uri $url -Method Get -Headers $headers

# Проверка структуры ответа
$response.transactions.Count
$response.transactions[0] | ConvertTo-Json
```

Ожидаемый результат:
- `$response.transactions` должен быть массивом
- Каждый элемент должен содержать `date`, `cardNum`, `TypeID`

