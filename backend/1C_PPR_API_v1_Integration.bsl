// Модуль интеграции с PPR API v1 для 1С ЕРП
//
// Назначение:
//   Предоставляет функции для получения данных о транзакциях ГСМ через PPR API v1
//   Использует POST-запросы с JSON в теле запроса
//
// Использование:
//   Модуль предназначен для использования в конфигурациях 1С:Предприятие 8.3
//   для интеграции с системой учета ГСМ через PPR API v1
//
// Требования:
//   - Версия платформы: 8.3.23 и выше
//   - Доступ к HTTP-сервисам
//   - Настроенное подключение к API серверу
//   - SSL-соединение для HTTPS

#Область ПрограммныйИнтерфейс

// Получить транзакции за период через PPR API v1
//
// Параметры:
//   URL - Строка - Адрес сервера без протокола (например, "malignantly-meteoric-stallion.cloudpub.ru")
//   Токен - Строка - API ключ для авторизации
//   ДатаНачала - Дата - Начальная дата периода (включительно)
//   ДатаОкончания - Дата - Конечная дата периода (включительно)
//   Транзакции - ТаблицаЗначений - Таблица для заполнения транзакциями
//
// Возвращаемое значение:
//   Булево - Признак успешного выполнения запроса
//
Процедура ПолучениеТранзакцийЗаПериодППР(URL, Токен, ДатаНачала, ДатаОкончания, Транзакции) Экспорт
	
	dateFrom = Формат(ДатаНачала, "ДФ=yyyy-MM-dd");
	dateTo = Формат(ДатаОкончания, "ДФ=yyyy-MM-dd");
	
	// API v1 использует POST-запрос с JSON в теле
	Ресурс = "/public-api/v1/transaction-list";
	Метод = "ТранзакцийЗаПериодППР";
	
	// Формируем тело запроса в формате JSON
	ТелоЗапроса = Новый Структура;
	ТелоЗапроса.Вставить("token", Токен);
	ТелоЗапроса.Вставить("dateFrom", dateFrom);
	ТелоЗапроса.Вставить("dateTo", dateTo);
	ТелоЗапроса.Вставить("format", "JSON");
	
	// Преобразуем структуру в JSON строку
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ТелоЗапроса);
	ТелоJSON = ЗаписьJSON.Закрыть();
	
	СоотвИзJSON = ВыполнитьHTTPЗапросППР_POST(URL, Ресурс, ТелоJSON, Метод);
	
	Если НЕ СоотвИзJSON = Неопределено Тогда
		// В API v1 ответ содержит поле "array-list" вместо "transactions"
		Если СоотвИзJSON.Свойство("array-list") Тогда
			МассивТранзакций = СоотвИзJSON["array-list"];
			Если МассивТранзакций.Количество() > 0 Тогда
				Для каждого ЭлТранзакции из МассивТранзакций Цикл
					НовТранзакция = Транзакции.Добавить();
					ЗаполнитьЗначенияСвойств(НовТранзакция, ЭлТранзакции);
					НовТранзакция.Дата = ПрочитатьДатуJSON(ЭлТранзакции.date, ФорматДатыJSON.ISO);
					НовТранзакция.cardNum = Формат(ЭлТранзакции.cardNum, "ЧГ=");
					Если ЭлТранзакции.TypeID = 1 Тогда
						НовТранзакция.TypeID = "Заправка";
					Иначе
						НовТранзакция.TypeID = "Возврат";
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		Иначе
			Сообщить("Ошибка: В ответе отсутствует поле 'array-list'");
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Выполнить HTTP POST-запрос к PPR API v1
//
// Параметры:
//   URL - Строка - Адрес сервера без протокола (например, "malignantly-meteoric-stallion.cloudpub.ru")
//   Ресурс - Строка - Путь к ресурсу (например, "/api/public-api/v1/transaction-list")
//   ТелоJSON - Строка - JSON строка для тела запроса
//   Метод - Строка - Название метода для логирования ошибок
//
// Возвращаемое значение:
//   Соответствие - Результат парсинга JSON ответа, или Неопределено в случае ошибки
//
Функция ВыполнитьHTTPЗапросППР_POST(URL, Ресурс, ТелоJSON, Метод)
	
	Попытка
		// Используем HTTPS для безопасного соединения
		ssl = Новый ЗащищенноеСоединениеOpenSSL();
		
		// Формируем заголовки запроса
		ЗаголовокЗапросаHTTP = Новый Соответствие;
		ЗаголовокЗапросаHTTP.Вставить("Content-Type", "application/json");
		ЗаголовокЗапросаHTTP.Вставить("Accept", "application/json");
		
		// Создаем HTTP-соединение (HTTPS, так как используем SSL)
		// Формат: HTTPСоединение(Хост, Порт, Пользователь, Пароль, Прокси, Таймаут, ЗащищенноеСоединение)
		// Для HTTPS порт обычно 443, но можно не указывать (по умолчанию 80 для HTTP, 443 для HTTPS)
		Соединение = Новый HTTPСоединение(URL, , , , , , ssl);
		
		// Создаем HTTP-запрос с методом POST
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс, ЗаголовокЗапросаHTTP);
		HTTPЗапрос.Метод = "POST";
		
		// Устанавливаем тело запроса
		HTTPЗапрос.УстановитьТелоИзСтроки(ТелоJSON);
		
		// Выполняем запрос
		Ответ = Соединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
		
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (Соединение.ВызватьHTTPМетод) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	// Проверяем код состояния ответа
	Если Ответ.КодСостояния <> 200 Тогда
		Сообщить("Ошибка работы " + Метод + " Ответ.КодСостояния <> 200 " + Ресурс + " " + Ответ.ПолучитьТелоКакСтроку());
		Возврат Неопределено;
	КонецЕсли;
	
	// Получаем тело ответа
	ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
	
	Попытка
		// Парсим JSON ответ
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		СоотвИзJSON = ПрочитатьJSON(ЧтениеJSON);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (ПрочитатьJSON) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат СоотвИзJSON;
	
КонецФункции

// Альтернативная функция для GET-запросов (для совместимости с v2)
//
// Параметры:
//   URL - Строка - Адрес сервера без протокола
//   Ресурс - Строка - Путь к ресурсу
//   Токен - Строка - API ключ для авторизации
//   Метод - Строка - Название метода для логирования ошибок
//
// Возвращаемое значение:
//   Соответствие - Результат парсинга JSON ответа, или Неопределено в случае ошибки
//
Функция ВыполнитьHTTPЗапросППР(URL, Ресурс, Токен, Метод)
	
	Попытка
		// Определяем, используется ли HTTPS по наличию "https://" в URL или по порту
		ИспользоватьSSL = Ложь;
		
		// Если URL содержит "https://", используем SSL
		Если СтрНайти(URL, "https://") > 0 Тогда
			ИспользоватьSSL = Истина;
			// Убираем протокол из URL
			URL = СтрЗаменить(URL, "https://", "");
		ИначеЕсли СтрНайти(URL, "http://") > 0 Тогда
			URL = СтрЗаменить(URL, "http://", "");
		КонецЕсли;
		
		// Если используется HTTPS, создаем SSL соединение
		ssl = Неопределено;
		Если ИспользоватьSSL Тогда
			ssl = Новый ЗащищенноеСоединениеOpenSSL();
		КонецЕсли;
		
		ЗаголовокЗапросаHTTP = Новый Соответствие;
		ЗаголовокЗапросаHTTP.Вставить("Content-Type", "application/json");
		ЗаголовокЗапросаHTTP.Вставить("Authorization", Токен);
		
		Соединение = Новый HTTPСоединение(URL, , , , , , ssl);
		HTTPЗапрос = Новый HTTPЗапрос(Ресурс, ЗаголовокЗапросаHTTP);
		Ответ = Соединение.Получить(HTTPЗапрос);
		
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (Соединение.Получить) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Если Ответ.КодСостояния <> 200 Тогда
		Сообщить("Ошибка работы " + Метод + " Ответ.КодСостояния <> 200 " + Ресурс + " " + Ответ.ПолучитьТелоКакСтроку());
		Возврат Неопределено;
	КонецЕсли;
	
	ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
	
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		СоотвИзJSON = ПрочитатьJSON(ЧтениеJSON);
	Исключение
		Сообщить("Ошибка работы " + Метод + " Исключение (ПрочитатьJSON) " + Ресурс + " " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат СоотвИзJSON;
	
КонецФункции

#КонецОбласти

