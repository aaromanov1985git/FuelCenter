// Модуль интеграции с API GSM Converter
//
// Назначение:
//   Предоставляет функции для получения данных о транзакциях ГСМ из веб-портала
//   через REST API. Поддерживает фильтрацию по провайдерам, датам и пагинацию.
//
// Использование:
//   Модуль предназначен для использования в конфигурациях 1С:Предприятие 8.3
//   для интеграции с системой учета ГСМ.
//
// Требования:
//   - Версия платформы: 8.3.23 и выше
//   - Доступ к HTTP-сервисам
//   - Настроенное подключение к API серверу
//
#Область ПрограммныйИнтерфейс

// Получить транзакции за период по провайдеру
//
// Параметры:
//   АдресСервера - Строка - Адрес API сервера (например, "http://localhost:8000")
//   ИДПровайдера - Число - ID провайдера для фильтрации транзакций
//   ДатаНачала - Дата - Начальная дата периода (включительно), необязательный параметр
//   ДатаОкончания - Дата - Конечная дата периода (включительно), необязательный параметр
//   Пропустить - Число - Количество записей для пропуска (для пагинации), по умолчанию 0
//   Лимит - Число - Максимальное количество записей на странице, по умолчанию 1000
//
// Возвращаемое значение:
//   Структура - Результат выполнения запроса:
//     * Успех - Булево - Признак успешного выполнения запроса
//     * Транзакции - Массив - Массив структур с данными транзакций
//     * ВсегоЗаписей - Число - Общее количество записей, соответствующих фильтрам
//     * СообщениеОбОшибке - Строка - Текст ошибки (заполняется при Успех = Ложь)
//
// Исключения:
//   Обрабатываются все исключения, возвращается структура с Успех = Ложь
//
Функция ПолучитьТранзакцииЗаПериодПоПровайдеру(
	АдресСервера, 
	ИДПровайдера, 
	ДатаНачала = Неопределено, 
	ДатаОкончания = Неопределено, 
	Пропустить = 0, 
	Лимит = 1000) Экспорт
	
	Попытка
		
		// Формируем базовый URL запроса к API
		URL = АдресСервера + "/api/v1/transactions";
		
		// Формируем параметры запроса
		ПараметрыЗапроса = Новый Массив;
		ПараметрыЗапроса.Добавить("provider_id=" + Формат(ИДПровайдера, "ЧГ="));
		
		Если ДатаНачала <> Неопределено Тогда
			
			ПараметрыЗапроса.Добавить("date_from=" + Формат(ДатаНачала, "ДФ=yyyy-MM-dd"));
			
		КонецЕсли;
		
		Если ДатаОкончания <> Неопределено Тогда
			
			ПараметрыЗапроса.Добавить("date_to=" + Формат(ДатаОкончания, "ДФ=yyyy-MM-dd"));
			
		КонецЕсли;
		
		Если Пропустить > 0 Тогда
			
			ПараметрыЗапроса.Добавить("skip=" + Формат(Пропустить, "ЧГ="));
			
		КонецЕсли;
		
		Если Лимит <> 1000 Тогда
			
			ПараметрыЗапроса.Добавить("limit=" + Формат(Лимит, "ЧГ="));
			
		КонецЕсли;
		
		URL = URL + "?" + СтрСоединить(ПараметрыЗапроса, "&");
		
		// Создаем HTTP-соединение с сервером
		Соединение = Новый HTTPСоединение(АдресСервера);
		
		// Формируем HTTP-запрос с заголовками
		Запрос = Новый HTTPЗапрос(URL);
		Запрос.Заголовки.Вставить("Content-Type", "application/json");
		Запрос.Заголовки.Вставить("Accept", "application/json");
		
		// Выполняем GET-запрос к API
		HTTPСервисОтвет = Соединение.Получить(Запрос);
		
		// Проверяем код состояния ответа
		Если HTTPСервисОтвет.КодСостояния <> 200 Тогда
			
			Возврат Новый Структура("Успех, СообщениеОбОшибке", 
				Ложь, 
				"Ошибка HTTP: " + Формат(HTTPСервисОтвет.КодСостояния, "ЧГ=") + ". " + 
				HTTPСервисОтвет.ПолучитьТелоКакСтроку());
			
		КонецЕсли;
		
		// Получаем тело ответа в виде строки
		ТелоОтвета = HTTPСервисОтвет.ПолучитьТелоКакСтроку();
		
		// Парсим JSON-ответ
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
		ПарсерJSON = Новый ПарсерJSON;
		ДанныеОтвета = ПарсерJSON.Прочитать(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		// Инициализируем структуру результата
		Результат = Новый Структура;
		Результат.Вставить("Успех", Истина);
		Результат.Вставить("Транзакции", Новый Массив);
		Результат.Вставить("ВсегоЗаписей", 0);
		Результат.Вставить("СообщениеОбОшибке", "");
		
		// Извлекаем общее количество записей
		Если ДанныеОтвета.Свойство("total") Тогда
			
			Результат.ВсегоЗаписей = ДанныеОтвета.total;
			
		КонецЕсли;
		
		// Обрабатываем массив транзакций
		Если ДанныеОтвета.Свойство("items") И ТипЗнч(ДанныеОтвета.items) = Тип("Массив") Тогда
			
			Для Каждого ЭлементТранзакции Из ДанныеОтвета.items Цикл
				
				// Формируем структуру транзакции
				Транзакция = Новый Структура;
				Транзакция.Вставить("ИД", ЭлементТранзакции.id);
				Транзакция.Вставить("ДатаТранзакции", 
					ПреобразоватьДатуИзISO(ЭлементТранзакции.transaction_date));
				Транзакция.Вставить("НомерКарты", Строка(ЭлементТранзакции.card_number));
				Транзакция.Вставить("ТранспортноеСредство", Строка(ЭлементТранзакции.vehicle));
				Транзакция.Вставить("ИДТранспортногоСредства", 
					?(ЭлементТранзакции.Свойство("vehicle_id"), 
						ЭлементТранзакции.vehicle_id, 
						Неопределено));
				Транзакция.Вставить("НомерАЗС", Строка(ЭлементТранзакции.azs_number));
				Транзакция.Вставить("Товар", Строка(ЭлементТранзакции.product));
				Транзакция.Вставить("ТипОперации", Строка(ЭлементТранзакции.operation_type));
				Транзакция.Вставить("Количество", Число(ЭлементТранзакции.quantity));
				Транзакция.Вставить("Валюта", Строка(ЭлементТранзакции.currency));
				Транзакция.Вставить("КурсВалюты", Число(ЭлементТранзакции.exchange_rate));
				Транзакция.Вставить("Цена", 
					?(ЭлементТранзакции.Свойство("price"), 
						Число(ЭлементТранзакции.price), 
						Неопределено));
				Транзакция.Вставить("Сумма", 
					?(ЭлементТранзакции.Свойство("amount"), 
						Число(ЭлементТранзакции.amount), 
						Неопределено));
				Транзакция.Вставить("ИДПровайдера", 
					?(ЭлементТранзакции.Свойство("provider_id"), 
						ЭлементТранзакции.provider_id, 
						Неопределено));
				Транзакция.Вставить("НаименованиеПровайдера", 
					?(ЭлементТранзакции.Свойство("provider_name"), 
						Строка(ЭлементТранзакции.provider_name), 
						""));
				Транзакция.Вставить("Поставщик", 
					?(ЭлементТранзакции.Свойство("supplier"), 
						Строка(ЭлементТранзакции.supplier), 
						""));
				Транзакция.Вставить("Регион", 
					?(ЭлементТранзакции.Свойство("region"), 
						Строка(ЭлементТранзакции.region), 
						""));
				Транзакция.Вставить("НаселенныйПункт", 
					?(ЭлементТранзакции.Свойство("settlement"), 
						Строка(ЭлементТранзакции.settlement), 
						""));
				Транзакция.Вставить("Местоположение", 
					?(ЭлементТранзакции.Свойство("location"), 
						Строка(ЭлементТранзакции.location), 
						""));
				Транзакция.Вставить("Организация", 
					?(ЭлементТранзакции.Свойство("organization"), 
						Строка(ЭлементТранзакции.organization), 
						""));
				Транзакция.Вставить("ИсточникФайла", 
					?(ЭлементТранзакции.Свойство("source_file"), 
						Строка(ЭлементТранзакции.source_file), 
						""));
				Транзакция.Вставить("ДатаСоздания", 
					ПреобразоватьДатуИзISO(ЭлементТранзакции.created_at));
				
				Результат.Транзакции.Добавить(Транзакция);
				
			КонецЦикла;
			
		КонецЕсли;
		
		Возврат Результат;
		
	Исключение
		
		// Возвращаем структуру с ошибкой при любом исключении
		Возврат Новый Структура("Успех, СообщениеОбОшибке", 
			Ложь, 
			"Ошибка при выполнении запроса: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецФункции

// Преобразовать дату из ISO формата в дату 1С
//
// Параметры:
//   СтрокаДаты - Строка - Дата в формате ISO 8601
//                  Поддерживаемые форматы:
//                  - "YYYY-MM-DD" - только дата
//                  - "YYYY-MM-DDTHH:MM:SS" - дата и время
//                  - "YYYY-MM-DDTHH:MM:SS.fff" - дата и время с миллисекундами
//
// Возвращаемое значение:
//   Дата - Дата в формате 1С
//   Неопределено - если строка пустая или не удалось распарсить
//
Функция ПреобразоватьДатуИзISO(СтрокаДаты)
	
	Если ПустаяСтрока(СтрокаДаты) Тогда
		
		Возврат Неопределено;
		
	КонецЕсли;
	
	Попытка
		
		// Разделяем дату и время по символу "T"
		// Формат: "2025-01-15T10:30:00" или "2025-01-15T10:30:00.123456"
		ЧастиДаты = СтрРазделить(СтрокаДаты, "T");
		
		Если ЧастиДаты.Количество() < 2 Тогда
			
			// Только дата без времени (формат "YYYY-MM-DD")
			ЧастиДаты = СтрРазделить(СтрокаДаты, "-");
			
			Если ЧастиДаты.Количество() = 3 Тогда
				
				Возврат Дата(
					Число(ЧастиДаты[0]), 
					Число(ЧастиДаты[1]), 
					Число(ЧастиДаты[2]));
				
			КонецЕсли;
			
		Иначе
			
			// Дата и время (формат "YYYY-MM-DDTHH:MM:SS")
			ЧастиДатыДня = СтрРазделить(ЧастиДаты[0], "-");
			ЧастиВремени = СтрРазделить(ЧастиДаты[1], ":");
			
			Если ЧастиВремени.Количество() >= 3 Тогда
				
				// Убираем миллисекунды, если есть (формат "SS.fff")
				Секунды = СтрРазделить(ЧастиВремени[2], ".");
				СекундыЗначение = Число(Секунды[0]);
				
			Иначе
				
				СекундыЗначение = 0;
				
			КонецЕсли;
			
			Возврат Дата(
				Число(ЧастиДатыДня[0]), 
				Число(ЧастиДатыДня[1]), 
				Число(ЧастиДатыДня[2]),
				Число(ЧастиВремени[0]),
				Число(ЧастиВремени[1]),
				СекундыЗначение);
			
		КонецЕсли;
		
	Исключение
		
		// При ошибке парсинга возвращаем текущую дату
		// Это позволяет не прерывать обработку при некорректных данных
		Возврат ТекущаяДата();
		
	КонецПопытки;
	
	// Если формат не распознан, возвращаем Неопределено
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПримерыИспользования

// Пример 1: Получить все транзакции за месяц
//
// Назначение:
//   Демонстрирует получение всех транзакций за указанный период
//   для конкретного провайдера без использования пагинации
//
Процедура Пример1_ПолучитьТранзакцииЗаМесяц()
	
	АдресСервера = "http://localhost:8000";
	ИДПровайдера = 1;
	ДатаНачала = Дата(2025, 1, 1);
	ДатаОкончания = Дата(2025, 1, 31);
	
	Результат = ПолучитьТранзакцииЗаПериодПоПровайдеру(АдресСервера, ИДПровайдера, ДатаНачала, ДатаОкончания);
	
	Если Результат.Успех Тогда
		
		Сообщить("Получено транзакций: " + Формат(Результат.Транзакции.Количество(), "ЧГ="));
		Сообщить("Всего записей в базе: " + Формат(Результат.ВсегоЗаписей, "ЧГ="));
		
		Для Каждого Транзакция Из Результат.Транзакции Цикл
			
			Сообщить(СтрШаблон("Транзакция #%1: %2, %3 л, %4 руб.", 
				Транзакция.ИД, 
				Формат(Транзакция.ДатаТранзакции, "ДФ=dd.MM.yyyy HH:mm:ss"),
				Формат(Транзакция.Количество, "ЧЦ=2; ЧДЦ=2"),
				Формат(Транзакция.Сумма, "ЧЦ=2; ЧДЦ=2")));
			
		КонецЦикла;
		
	Иначе
		
		Сообщить("Ошибка: " + Результат.СообщениеОбОшибке);
		
	КонецЕсли;
	
КонецПроцедуры

// Пример 2: Получить транзакции с пагинацией
//
// Назначение:
//   Демонстрирует использование пагинации для получения больших объемов данных
//   Обрабатывает все транзакции постранично
//
Процедура Пример2_ПолучитьТранзакцииСПагинацией()
	
	АдресСервера = "http://localhost:8000";
	ИДПровайдера = 1;
	ДатаНачала = Дата(2025, 1, 1);
	ДатаОкончания = Дата(2025, 1, 31);
	ЛимитНаСтранице = 100;
	Пропустить = 0;
	
	Пока Истина Цикл
		
		Результат = ПолучитьТранзакцииЗаПериодПоПровайдеру(
			АдресСервера, 
			ИДПровайдера, 
			ДатаНачала, 
			ДатаОкончания,
			Пропустить,
			ЛимитНаСтранице
		);
		
		Если Не Результат.Успех Тогда
			
			Сообщить("Ошибка: " + Результат.СообщениеОбОшибке);
			Прервать;
			
		КонецЕсли;
		
		Если Результат.Транзакции.Количество() = 0 Тогда
			
			Прервать;
			
		КонецЕсли;
		
		Сообщить(СтрШаблон("Страница: пропущено %1, получено %2 из %3", 
			Пропустить, 
			Результат.Транзакции.Количество(),
			Результат.ВсегоЗаписей));
		
		// Обработка транзакций на текущей странице
		Для Каждого Транзакция Из Результат.Транзакции Цикл
			
			// Здесь добавляется ваша логика обработки транзакции
			// Например, запись в регистр, создание документа и т.д.
			
		КонецЦикла;
		
		// Переходим на следующую страницу
		Пропустить = Пропустить + ЛимитНаСтранице;
		
		Если Пропустить >= Результат.ВсегоЗаписей Тогда
			
			Прервать;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Пример 3: Получить транзакции с максимальным лимитом
//
// Назначение:
//   Демонстрирует получение максимального количества записей за один запрос
//   Показывает предупреждение, если записей больше лимита
//
Процедура Пример3_ПолучитьВсеТранзакцииЗаПериод()
	
	АдресСервера = "http://localhost:8000";
	ИДПровайдера = 1;
	ДатаНачала = Дата(2025, 1, 1);
	ДатаОкончания = Дата(2025, 1, 31);
	
	// Получаем транзакции с максимальным лимитом (1000 записей)
	Результат = ПолучитьТранзакцииЗаПериодПоПровайдеру(
		АдресСервера, 
		ИДПровайдера, 
		ДатаНачала, 
		ДатаОкончания,
		0,
		1000);
	
	Если Результат.Успех Тогда
		
		// Проверяем, все ли записи получены
		Если Результат.ВсегоЗаписей > 1000 Тогда
			
			Сообщить("Внимание: получено только 1000 из " + Формат(Результат.ВсегоЗаписей, "ЧГ=") + 
				" транзакций. Используйте пагинацию для получения всех данных.");
			
		КонецЕсли;
		
		Сообщить("Получено транзакций: " + Формат(Результат.Транзакции.Количество(), "ЧГ="));
		
	Иначе
		
		Сообщить("Ошибка: " + Результат.СообщениеОбОшибке);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

