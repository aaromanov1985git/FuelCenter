# Решение проблемы отсутствия событий автозагрузки

## Текущая ситуация

Из логов видно, что:
1. ✅ Планировщик запускается успешно
2. ✅ Найдено 3 шаблона с расписанием (MAZS, PPRUTT, KAZS)
3. ✅ Все расписания добавлены успешно
4. ❓ Но события автозагрузки не появляются в журнале

## Возможные причины

### 1. Задачи запланированы на будущее

Если расписание "один раз в час", задача выполнится только когда наступит следующий час. Например, если сейчас 15:30, а задача запланирована на каждый час (0 минут), она выполнится в 16:00.

**Решение:** Проверьте время следующего выполнения через API:
```bash
GET /api/v1/templates/scheduler/status
```

Посмотрите поле `next_run_time` для каждой задачи.

### 2. Задачи выполняются, но события не записываются

**Проверка:** Смотрите логи на наличие:
- "Запуск автоматической загрузки по расписанию"
- "Запись события автозагрузки в журнал"
- "Событие автозагрузки успешно зафиксировано в журнале"

Если есть первое, но нет последних - проблема в записи событий.

### 3. Ошибки при выполнении задач

**Проверка:** Смотрите логи на ошибки:
- "Ошибка при выполнении автоматической загрузки по расписанию"
- "Не удалось зафиксировать событие автозагрузки"

## Диагностика

### Проверка статуса планировщика

```bash
# Через curl или браузер
GET http://localhost:8000/api/v1/templates/scheduler/status
```

Проверьте:
- `scheduler_running: true`
- `scheduled_jobs.total > 0`
- `recent_auto_events.total` - есть ли события за последние 7 дней

### Проверка логов

```bash
# В PowerShell
docker-compose logs backend --tail=200

# Ищите:
# - "Планировщик задач автоматической загрузки запущен"
# - "Добавлено расписание для шаблона"
# - "Запуск автоматической загрузки по расписанию"
# - "Событие автозагрузки успешно зафиксировано в журнале"
```

### Проверка БД напрямую

```sql
-- Проверка событий автозагрузки
SELECT 
    id,
    created_at,
    source_type,
    is_scheduled,
    status,
    file_name,
    template_id,
    transactions_created,
    message
FROM upload_events
WHERE source_type = 'auto' 
  AND is_scheduled = true
ORDER BY created_at DESC
LIMIT 20;

-- Проверка шаблонов с расписанием
SELECT 
    id,
    name,
    is_active,
    auto_load_enabled,
    auto_load_schedule
FROM provider_templates
WHERE is_active = true 
  AND auto_load_enabled = true 
  AND auto_load_schedule IS NOT NULL 
  AND auto_load_schedule != '';
```

## Ручной запуск для тестирования

Для немедленной проверки работы автозагрузки:

```bash
POST http://localhost:8000/api/v1/templates/auto-load
```

Это запустит загрузку для всех шаблонов с `auto_load_enabled = true` и создаст события в журнале.

## Что было исправлено

1. ✅ Добавлено детальное логирование на всех этапах
2. ✅ Улучшена обработка ошибок
3. ✅ Добавлен endpoint для диагностики (`/api/v1/templates/scheduler/status`)
4. ✅ Исправлена проблема с авторизацией при загрузке через API

## Следующие шаги

1. Проверьте статус планировщика через API
2. Проверьте время следующего выполнения задач
3. Запустите ручную загрузку для проверки записи событий
4. Проверьте логи на наличие ошибок при выполнении задач
