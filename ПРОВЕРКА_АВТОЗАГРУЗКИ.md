# Проверка работы автоматической загрузки

## Быстрая диагностика

### 1. Проверка статуса планировщика

Используйте endpoint для проверки:

```bash
GET /api/v1/templates/scheduler/status
```

Этот endpoint покажет:
- Запущен ли планировщик (`scheduler_running`)
- Список запланированных задач (`scheduled_jobs`)
- Информацию о шаблонах с расписанием
- **Последние события автозагрузки за 7 дней** (`recent_auto_events`)

### 2. Проверка событий в БД напрямую

Выполните SQL запрос:

```sql
-- Последние события автозагрузки
SELECT 
    id,
    created_at,
    source_type,
    is_scheduled,
    status,
    file_name,
    template_id,
    transactions_created,
    transactions_total,
    message
FROM upload_events
WHERE source_type = 'auto' 
  AND is_scheduled = true
ORDER BY created_at DESC
LIMIT 20;
```

### 3. Проверка логов приложения

При запуске приложения должны быть логи:
```
Планировщик задач автоматической загрузки запущен
Загрузка расписаний автоматической загрузки
Расписания автоматической загрузки загружены
```

При выполнении задач должны быть логи:
```
Запуск автоматической загрузки по расписанию
Автоматическая загрузка для шаблона
Запись события автозагрузки в журнал
Событие автозагрузки успешно зафиксировано в журнале
```

## Возможные проблемы

### Проблема 1: Планировщик не запускается

**Симптомы:**
- `scheduler_running: false` в ответе `/api/v1/templates/scheduler/status`
- Нет логов о запуске планировщика

**Решение:**
1. Проверьте логи при старте приложения на наличие ошибок
2. Перезапустите приложение
3. Проверьте, что APScheduler установлен: `pip install apscheduler`

### Проблема 2: Задачи не запланированы

**Симптомы:**
- `scheduled_jobs.total: 0`
- `templates_with_schedule.total > 0`, но `has_scheduled_job: false`

**Решение:**
1. Проверьте, что шаблоны имеют:
   - `is_active = true`
   - `auto_load_enabled = true`
   - `auto_load_schedule` заполнено и не пустое
2. Проверьте логи на ошибки парсинга расписания
3. Используйте endpoint `/api/v1/templates/scheduler/status` для проверки

### Проблема 3: Задачи не выполняются

**Симптомы:**
- Задачи запланированы (`has_scheduled_job: true`)
- Но нет событий в `recent_auto_events`
- `next_run_time` в прошлом, но событий нет

**Решение:**
1. Проверьте логи на ошибки выполнения задач
2. Проверьте, что шаблоны активны и автозагрузка включена
3. Проверьте настройки подключения в шаблонах (Firebird/API)

### Проблема 4: События не записываются

**Симптомы:**
- В логах есть "Запуск автоматической загрузки по расписанию"
- Но нет "Событие автозагрузки успешно зафиксировано в журнале"
- В БД нет записей в `upload_events`

**Решение:**
1. Проверьте логи на ошибки "Не удалось зафиксировать событие автозагрузки"
2. Проверьте подключение к БД
3. Проверьте права доступа к таблице `upload_events`

## Ручной запуск для тестирования

Для проверки работы автозагрузки можно запустить вручную:

```bash
POST /api/v1/templates/auto-load
```

Это запустит загрузку для всех шаблонов с `auto_load_enabled = true` (независимо от расписания).

## Проверка через интерфейс

1. Откройте раздел "События загрузок"
2. Установите фильтр "Источник" = "Регламентная"
3. Проверьте, есть ли события

Если событий нет:
- Проверьте фильтры (возможно, установлены даты, когда не было загрузок)
- Сбросьте фильтры
- Проверьте статус планировщика через API

## Дополнительная диагностика

### Проверка через API

```bash
# Статус планировщика с последними событиями
curl http://localhost:8000/api/v1/templates/scheduler/status

# События автозагрузки
curl "http://localhost:8000/api/v1/upload-events?source_type=auto&is_scheduled=true"
```

### Проверка в логах

Ищите следующие сообщения:
- `"Планировщик задач автоматической загрузки запущен"` - планировщик запустился
- `"Добавлено расписание для шаблона"` - задача добавлена
- `"Запуск автоматической загрузки по расписанию"` - задача выполняется
- `"Событие автозагрузки успешно зафиксировано в журнале"` - событие записано

## Что было исправлено

1. **Добавлено детальное логирование:**
   - Логирование перед записью события
   - Проверка, что событие действительно создано
   - Логирование ID созданного события

2. **Улучшен endpoint статуса:**
   - Добавлена информация о последних событиях автозагрузки
   - Показывает события за последние 7 дней

3. **Улучшена обработка ошибок:**
   - Детальное логирование ошибок при записи событий
   - Логирование типа ошибки

## Рекомендации

1. Регулярно проверяйте статус планировщика через API
2. Мониторьте логи на наличие ошибок
3. Проверяйте события в БД напрямую, если в интерфейсе их нет
4. Используйте ручной запуск для тестирования перед настройкой расписания
