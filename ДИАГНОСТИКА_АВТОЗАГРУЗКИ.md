# Диагностика проблем автоматической загрузки

## Быстрая диагностика

### 1. Проверка статуса планировщика через API

Используйте новый endpoint для проверки статуса планировщика:

```bash
GET /api/v1/templates/scheduler/status
```

Этот endpoint вернет:
- Статус планировщика (запущен/остановлен)
- Список запланированных задач
- Информацию о шаблонах с расписанием
- Время следующего запуска для каждой задачи

### 2. Проверка логов при старте приложения

При запуске приложения должны появиться следующие логи:

```
Планировщик задач автоматической загрузки запущен
Загрузка расписаний автоматической загрузки
Расписания автоматической загрузки загружены
```

Если этих логов нет, значит планировщик не запустился.

### 3. Проверка наличия шаблонов с расписанием

Убедитесь, что есть шаблоны с:
- `is_active = True`
- `auto_load_enabled = True`
- `auto_load_schedule IS NOT NULL` и не пустая строка

## Возможные проблемы и решения

### Проблема 1: Планировщик не запускается

**Симптомы:**
- В логах нет сообщения "Планировщик задач автоматической загрузки запущен"
- Endpoint `/api/v1/templates/scheduler/status` возвращает `scheduler_running: false`

**Причины:**
1. Ошибка при инициализации планировщика
2. Проблемы с зависимостями (APScheduler не установлен)
3. Ошибки в startup_event, которые прерывают выполнение

**Решение:**
1. Проверьте логи при старте приложения на наличие ошибок
2. Убедитесь, что APScheduler установлен: `pip install apscheduler`
3. Проверьте, что нет ошибок в startup_event до запуска планировщика

### Проблема 2: Нет запланированных задач

**Симптомы:**
- Планировщик запущен, но `scheduled_jobs.total = 0`
- В логах: "Не найдено шаблонов с настроенным расписанием автоматической загрузки"

**Причины:**
1. Нет шаблонов с включенной автозагрузкой и расписанием
2. Все шаблоны неактивны или автозагрузка отключена
3. Расписание не заполнено или пустое

**Решение:**
1. Проверьте шаблоны в БД:
   ```sql
   SELECT id, name, is_active, auto_load_enabled, auto_load_schedule 
   FROM provider_templates 
   WHERE is_active = true 
     AND auto_load_enabled = true 
     AND auto_load_schedule IS NOT NULL 
     AND auto_load_schedule != '';
   ```

2. Убедитесь, что расписание заполнено правильно (см. формат расписания ниже)

### Проблема 3: Ошибки при парсинге расписания

**Симптомы:**
- В логах: "Ошибка при парсинге расписания"
- В логах: "Ошибка при добавлении расписания для шаблона"

**Причины:**
- Неверный формат расписания
- Неподдерживаемый формат

**Решение:**
Проверьте формат расписания. Поддерживаемые форматы:

1. **Простой формат:**
   - `daily` или `day` - каждый день в 2:00
   - `hourly` или `hour` - каждый час
   - `weekly` или `week` - каждую неделю в понедельник в 2:00

2. **Интервальный формат:**
   - `every N hours` - каждые N часов
   - `every N minutes` - каждые N минут

3. **Cron-формат:**
   - `минута час день месяц день_недели`
   - Примеры:
     - `0 2 * * *` - каждый день в 2:00
     - `0 */6 * * *` - каждые 6 часов
     - `0 0 * * 1` - каждый понедельник в полночь

### Проблема 4: Задачи не выполняются

**Симптомы:**
- Задачи запланированы, но не выполняются
- Нет событий в журнале загрузок (`upload_events`)

**Причины:**
1. Планировщик остановлен
2. Ошибки при выполнении задач
3. Проблемы с доступом к БД или внешним системам

**Решение:**
1. Проверьте статус планировщика через API
2. Проверьте логи на наличие ошибок при выполнении задач
3. Проверьте события в журнале загрузок с фильтром `is_scheduled=true`

### Проблема 5: Ошибки при выполнении задач

**Симптомы:**
- В логах: "Ошибка при выполнении автоматической загрузки по расписанию"
- События в журнале со статусом `failed`

**Причины:**
1. Шаблон не найден или отключен
2. Ошибки подключения к Firebird/API
3. Ошибки обработки данных

**Решение:**
1. Проверьте, что шаблон активен и автозагрузка включена
2. Проверьте настройки подключения в шаблоне
3. Проверьте логи на детали ошибки

## Ручной запуск автоматической загрузки

Для тестирования можно запустить автоматическую загрузку вручную:

```bash
POST /api/v1/templates/auto-load
```

Это запустит загрузку для всех шаблонов с включенной автозагрузкой (независимо от расписания).

## Перезагрузка расписаний

Если вы изменили расписание в шаблоне, расписания автоматически перезагружаются при:
- Обновлении шаблона через API
- Обновлении провайдера (если это влияет на шаблоны)

Для принудительной перезагрузки расписаний можно использовать метод `reload_schedules()` в коде или перезапустить приложение.

## Мониторинг

### Проверка через API

```bash
# Статус планировщика
GET /api/v1/templates/scheduler/status

# События автоматической загрузки
GET /api/v1/upload-events?is_scheduled=true&source_type=auto

# Системные логи планировщика
GET /api/v1/logs/system?event_type=scheduler
```

### Проверка в БД

```sql
-- События автоматической загрузки
SELECT * FROM upload_events 
WHERE is_scheduled = true 
  AND source_type = 'auto'
ORDER BY created_at DESC 
LIMIT 10;

-- Системные логи планировщика
SELECT * FROM system_logs 
WHERE event_type = 'scheduler'
ORDER BY created_at DESC 
LIMIT 10;
```

## Рекомендации

1. **Регулярно проверяйте логи** на наличие ошибок планировщика
2. **Мониторьте события загрузок** для выявления проблем
3. **Используйте endpoint диагностики** для проверки статуса
4. **Тестируйте расписания** на простых интервалах перед использованием cron
5. **Проверяйте доступность** внешних систем (Firebird, API) перед настройкой автозагрузки

## Дополнительная информация

- Документ с анализом проблем: `АНАЛИЗ_ПРОБЛЕМ_АВТОЗАГРУЗКИ.md`
- Код планировщика: `backend/app/services/scheduler_service.py`
- Код автозагрузки: `backend/app/services/auto_load_service.py`
